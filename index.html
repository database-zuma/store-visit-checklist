<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Visit Checklist - Area Supervisor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .icon {
            width: 100px;
            height: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .login-logo .icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .login-logo h1 {
            color: #1a1a2e;
            font-size: 1.5rem;
        }

        .login-logo p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form input:focus {
            border-color: #e94560;
            outline: none;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e94560 0%, #d63050 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }

        .login-error {
            background: #ffe0e0;
            color: #c00;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }

        /* Main App */
        .app-container {
            display: none;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .header-title h1 {
            color: white;
            font-size: 1.3rem;
            margin-bottom: 3px;
        }

        .header-title p {
            color: #a0a0a0;
            font-size: 0.8rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 10px;
        }

        .user-info .avatar {
            width: 35px;
            height: 35px;
            background: #e94560;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-info .user-detail {
            color: white;
        }

        .user-info .user-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .user-info .user-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #e94560;
        }

        /* Dashboard Stats */
        .dashboard-section {
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .dash-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .dash-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .dash-card.primary::before { background: #e94560; }
        .dash-card.success::before { background: #28a745; }
        .dash-card.warning::before { background: #ffc107; }
        .dash-card.info::before { background: #17a2b8; }

        .dash-card .dash-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .dash-card .dash-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1a1a2e;
        }

        .dash-card .dash-label {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .dash-card .dash-sub {
            font-size: 0.75rem;
            color: #999;
            margin-top: 3px;
        }

        /* Progress Ring */
        .progress-ring-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .progress-ring {
            width: 60px;
            height: 60px;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
        }

        .progress-ring .bg {
            stroke: #e0e0e0;
        }

        .progress-ring .progress {
            stroke: #28a745;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s;
        }

        .progress-ring .progress.warning {
            stroke: #ffc107;
        }

        .progress-ring .progress.danger {
            stroke: #dc3545;
        }

        /* Store Status List */
        .store-status-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .store-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .store-status-header h3 {
            color: #1a1a2e;
            font-size: 1rem;
        }

        .store-status-header .badge {
            background: #e94560;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .store-status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .store-status-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 150px;
            background: white;
        }

        .store-status-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .store-status-item {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .store-status-item.visited {
            background: #d4edda;
            color: #155724;
        }

        .store-status-item.not-visited {
            background: #f8d7da;
            color: #721c24;
        }

        .store-status-item .status-icon {
            font-size: 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1a1a2e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e94560;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .icon {
            width: 30px;
            height: 30px;
            background: #e94560;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #e94560;
            outline: none;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Category Section */
        .category-section {
            margin-bottom: 25px;
        }

        .category-header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-header h3 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-header .badge {
            background: #e94560;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Checklist Item */
        .checklist-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checklist-item.yes {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .checklist-item.no {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .checklist-item-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .checklist-number {
            background: #1a1a2e;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .checklist-text {
            flex: 1;
            color: #333;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .checklist-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-yes, .btn-no, .btn-na {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .btn-yes {
            border-color: #28a745;
            background: white;
            color: #28a745;
        }

        .btn-yes:hover, .btn-yes.active {
            background: #28a745;
            color: white;
        }

        .btn-no {
            border-color: #dc3545;
            background: white;
            color: #dc3545;
        }

        .btn-no:hover, .btn-no.active {
            background: #dc3545;
            color: white;
        }

        .btn-na {
            border-color: #6c757d;
            background: white;
            color: #6c757d;
        }

        .btn-na:hover, .btn-na.active {
            background: #6c757d;
            color: white;
        }

        .checklist-extra {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            display: none;
        }

        .checklist-extra.show {
            display: block;
        }

        .checklist-extra textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
        }

        .checklist-extra .photo-upload {
            margin-top: 10px;
        }

        .photo-upload label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #e94560;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .photo-upload label:hover {
            background: #d63050;
        }

        .photo-upload input {
            display: none;
        }

        .photo-preview {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        /* Visit Proof Section */
        .visit-proof-section {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .visit-proof-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .visit-proof-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            align-items: start;
        }

        .visit-proof-photo {
            text-align: center;
        }

        .visit-proof-photo-preview {
            width: 180px;
            height: 180px;
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            overflow: hidden;
        }

        .visit-proof-photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .visit-proof-photo-preview .placeholder {
            color: rgba(255,255,255,0.5);
            font-size: 3rem;
        }

        .visit-proof-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #e94560;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: none;
        }

        .visit-proof-upload-btn:hover {
            background: #d63050;
            transform: translateY(-2px);
        }

        .visit-proof-upload-btn input {
            display: none;
        }

        .visit-proof-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .visit-proof-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .visit-proof-item .icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .visit-proof-item .info {
            flex: 1;
        }

        .visit-proof-item .info .label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .visit-proof-item .info .value {
            font-weight: bold;
            font-size: 1rem;
        }

        .visit-proof-item .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .visit-proof-item .status.success {
            background: #28a745;
        }

        .visit-proof-item .status.pending {
            background: #ffc107;
            color: #333;
        }

        .visit-proof-item .status.error {
            background: #dc3545;
        }

        .get-location-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .get-location-btn:hover {
            background: #218838;
        }

        .get-location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Checklist Item with Photo */
        .checklist-item-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .checklist-item-main {
            flex: 1;
        }

        .checklist-item-photo {
            width: 100px;
            flex-shrink: 0;
        }

        .checklist-photo-btn {
            width: 100%;
            height: 70px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .checklist-photo-btn:hover {
            border-color: #e94560;
            background: #fff5f7;
        }

        .checklist-photo-btn .camera-icon {
            font-size: 1.5rem;
            color: #999;
        }

        .checklist-photo-btn .photo-text {
            font-size: 0.7rem;
            color: #999;
        }

        .checklist-photo-btn input {
            display: none;
        }

        .checklist-photo-btn img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .checklist-photo-btn.has-photo {
            border-style: solid;
            border-color: #28a745;
        }

        @media (max-width: 768px) {
            .visit-proof-content {
                grid-template-columns: 1fr;
            }
            .visit-proof-photo {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .checklist-item-row {
                flex-direction: column;
            }
            .checklist-item-photo {
                width: 100%;
            }
            .checklist-photo-btn {
                height: 50px;
                flex-direction: row;
            }
        }

        /* BM View - hide form sections */
        .bm-view .form-section-hide {
            display: none !important;
        }

        /* BM Welcome Section */
        .bm-welcome {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .bm-welcome h2 {
            margin-bottom: 10px;
        }

        .bm-welcome p {
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .bm-welcome .btn-view-archive {
            padding: 15px 40px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bm-welcome .btn-view-archive:hover {
            background: #d63050;
            transform: translateY(-2px);
        }

        .bm-welcome-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .bm-welcome .btn-view-rules {
            padding: 15px 40px;
            background: #16213e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bm-welcome .btn-view-rules:hover {
            background: #0f3460;
            transform: translateY(-2px);
        }

        /* Dashboard Charts */
        .dashboard-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dashboard-header h3 {
            color: white;
            font-size: 1.1rem;
        }

        .dashboard-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .dashboard-filter select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .dashboard-filter select option {
            background: #1a1a2e;
            color: white;
        }

        .chart-container {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        .store-score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .store-score-table th,
        .store-score-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .store-score-table th {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .store-score-table td {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
        }

        .store-score-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .score-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .score-badge.good { background: #28a745; color: white; }
        .score-badge.average { background: #ffc107; color: #000; }
        .score-badge.poor { background: #dc3545; color: white; }
        .score-badge.none { background: #6c757d; color: white; }

        .visit-count-badge {
            background: rgba(255,255,255,0.15);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* Rules Modal */
        .rules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .rules-modal.show {
            display: flex;
        }

        .rules-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .rules-header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rules-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }

        .rules-body {
            padding: 25px;
        }

        .rules-section {
            margin-bottom: 25px;
        }

        .rules-section h3 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e94560;
            padding-bottom: 5px;
        }

        .rules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .rules-table th, .rules-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .rules-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .rules-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .rules-formula {
            background: #1a1a2e;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            text-align: center;
            margin: 15px 0;
        }

        .rules-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .score-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .score-badge.good { background: #d4edda; color: #155724; }
        .score-badge.average { background: #fff3cd; color: #856404; }
        .score-badge.poor { background: #f8d7da; color: #721c24; }

        /* Archive Detail Modal */
        .archive-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .archive-detail-modal.show {
            display: flex;
        }

        .archive-detail-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .archive-detail-header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .archive-detail-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .detail-section h4 {
            color: #1a1a2e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-item .label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 3px;
        }

        .detail-item .value {
            font-weight: bold;
            color: #1a1a2e;
        }

        .checklist-summary {
            max-height: 300px;
            overflow-y: auto;
        }

        .checklist-summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .checklist-summary-item .status {
            width: 60px;
            text-align: center;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .checklist-summary-item .status.yes {
            background: #d4edda;
            color: #155724;
        }

        .checklist-summary-item .status.no {
            background: #f8d7da;
            color: #721c24;
        }

        .checklist-summary-item .status.na {
            background: #e2e3e5;
            color: #383d41;
        }

        /* BM Review Section */
        .bm-review-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .bm-review-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .bm-review-section textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ffc107;
            border-radius: 8px;
            min-height: 100px;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .bm-review-section .btn-submit-review {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bm-review-section .btn-submit-review:hover {
            background: #218838;
        }

        .existing-review {
            background: #e8f5e9;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .existing-review .review-header {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .existing-review .review-content {
            color: #1a1a2e;
        }

        .visit-proof-thumbnail {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Score Section */
        .score-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: white;
        }

        .score-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .score-display.good { color: #28a745; }
        .score-display.average { color: #ffc107; }
        .score-display.poor { color: #dc3545; }

        .score-label {
            font-size: 1.5rem;
            padding: 10px 30px;
            border-radius: 30px;
            display: inline-block;
            margin-top: 10px;
        }

        .score-label.good { background: #28a745; }
        .score-label.average { background: #ffc107; color: #333; }
        .score-label.poor { background: #dc3545; }

        .score-details {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .score-detail-item {
            text-align: center;
        }

        .score-detail-item .number {
            font-size: 2rem;
            font-weight: bold;
        }

        .score-detail-item .label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Signature Section */
        .signature-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .signature-box {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .signature-box-header {
            background: #1a1a2e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .signature-box-body {
            padding: 15px;
            background: #fafafa;
        }

        .signature-box canvas {
            border: 1px dashed #ccc;
            border-radius: 8px;
            width: 100%;
            height: 100px;
            cursor: crosshair;
            background: white;
        }

        .signature-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .signature-box .btn-clear {
            margin-top: 8px;
            padding: 5px 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #e94560 0%, #d63050 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }

        .btn-secondary {
            background: #1a1a2e;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary:hover {
            background: #0f3460;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Progress Bar */
        .progress-section {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #28a745);
            border-radius: 5px;
            transition: width 0.3s;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        /* Archive */
        .archive-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .archive-filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .archive-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .archive-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .archive-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .archive-item-info h4 {
            color: #1a1a2e;
            margin-bottom: 5px;
        }

        .archive-item-info p {
            color: #666;
            font-size: 0.85rem;
        }

        .archive-item-score {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .archive-item-score.good { color: #28a745; }
        .archive-item-score.average { color: #ffc107; }
        .archive-item-score.poor { color: #dc3545; }

        .archive-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-delete-archive {
            background: #dc3545;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-delete-archive:hover {
            opacity: 1;
        }

        /* SPG Section */
        .spg-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Comment Box */
        .comment-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .comment-box label {
            color: #856404;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }

        .comment-box textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ffc107;
            border-radius: 8px;
            min-height: 100px;
            font-size: 0.95rem;
        }

        /* BM Dashboard in Archive */
        .bm-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .bm-stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .bm-stat-card .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1a1a2e;
        }

        .bm-stat-card .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .bm-stat-card.good .stat-number { color: #28a745; }
        .bm-stat-card.warning .stat-number { color: #ffc107; }
        .bm-stat-card.danger .stat-number { color: #dc3545; }

        /* Leaderboard */
        .leaderboard {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            color: #1a1a2e;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }

        .leaderboard-item.gold {
            background: linear-gradient(90deg, #fff9e6, #fff3cd);
            border: 1px solid #ffc107;
        }

        .leaderboard-item.silver {
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
        }

        .leaderboard-item.bronze {
            background: linear-gradient(90deg, #fff5f0, #ffe5d9);
            border: 1px solid #f5c6a5;
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9rem;
        }

        .leaderboard-item.gold .leaderboard-rank {
            background: #ffc107;
            color: #333;
        }

        .leaderboard-item.silver .leaderboard-rank {
            background: #adb5bd;
            color: white;
        }

        .leaderboard-item.bronze .leaderboard-rank {
            background: #d4a373;
            color: white;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            color: #1a1a2e;
        }

        .leaderboard-stats {
            font-size: 0.8rem;
            color: #666;
        }

        .leaderboard-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row, .spg-section {
                grid-template-columns: 1fr;
            }

            .signature-section {
                grid-template-columns: 1fr;
            }

            .checklist-item-header {
                flex-direction: column;
            }

            .checklist-buttons {
                width: 100%;
                justify-content: flex-start;
            }

            .score-details {
                flex-direction: column;
                gap: 15px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .bm-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon"><img src="assets/logo.png" alt="ZUMA Logo"></div>
                <h1>Store Visit Checklist</h1>
                <p>ZUMA Indonesia</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <form class="login-form" onsubmit="doLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <div class="header-logo"><img src="assets/logo.png" alt="ZUMA Logo"></div>
                    <div class="header-title">
                        <h1>Store Visit Checklist</h1>
                        <p>Area Supervisor Visit Form</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="avatar" id="userAvatar">A</div>
                        <div class="user-detail">
                            <div class="user-name" id="userName">User</div>
                            <div class="user-role" id="userRole">Role</div>
                        </div>
                    </div>
                    <button class="btn-logout" onclick="doLogout()">Logout</button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="dashboard-section form-section-hide" id="dashboardSection">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button id="refreshDashBtn" onclick="refreshDashboard()" style="padding:8px 16px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:5px;">
                        ðŸ”„ Refresh
                    </button>
                </div>
                <div class="dashboard-grid">
                    <div class="dash-card primary">
                        <div class="dash-icon">&#128202;</div>
                        <div class="dash-number" id="dashVisitCount">0</div>
                        <div class="dash-label">Visit Bulan Ini</div>
                        <div class="dash-sub" id="dashVisitTarget">Target: 0</div>
                    </div>
                    <div class="dash-card success">
                        <div class="dash-icon">&#127919;</div>
                        <div class="progress-ring-container">
                            <svg class="progress-ring" viewBox="0 0 60 60">
                                <circle class="bg" cx="30" cy="30" r="25"></circle>
                                <circle class="progress" id="progressRing" cx="30" cy="30" r="25"
                                    stroke-dasharray="157" stroke-dashoffset="157"></circle>
                            </svg>
                            <div>
                                <div class="dash-number" id="dashProgress">0%</div>
                                <div class="dash-label">Coverage</div>
                                <div class="dash-sub" id="dashCoverageSub">0/0 Store</div>
                            </div>
                        </div>
                    </div>
                    <div class="dash-card warning" id="dashCardScore">
                        <div class="dash-icon">&#11088;</div>
                        <div class="dash-number" id="dashAvgScore">-</div>
                        <div class="dash-label">Avg Score</div>
                        <div class="dash-sub" id="dashScoreStatus">-</div>
                    </div>
                    <div class="dash-card info">
                        <div class="dash-icon">&#127978;</div>
                        <div class="dash-number" id="dashPendingStore">0</div>
                        <div class="dash-label">Belum Visit</div>
                        <div class="dash-sub">bulan ini</div>
                    </div>
                </div>
            </div>

            <!-- Welcome Section (for BM/Admin) -->
            <div class="bm-welcome" id="bmWelcome" style="display: none;">
                <h2 id="welcomeTitle">&#128188; Selamat Datang!</h2>
                <p id="welcomeDesc">Anda dapat melihat progress visit dari Area Supervisor dan memberikan review/feedback.</p>
                <div class="bm-welcome-buttons">
                    <button class="btn-view-archive" onclick="openArchive()">&#128203; Lihat Arsip Visit</button>
                    <button class="btn-view-rules" onclick="openRules()">&#128220; Lihat Rules Penilaian</button>
                </div>

                <!-- Dashboard Charts Section -->
                <div class="dashboard-section" id="dashboardChartSection">
                    <div class="dashboard-header">
                        <h3>&#128202; Dashboard Score per Store</h3>
                        <div class="dashboard-filter">
                            <select id="chartMonthFilter" onchange="updateChartDashboard()">
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                            <select id="chartYearFilter" onchange="updateChartDashboard()">
                                <!-- Will be populated by JS -->
                            </select>
                            <select id="chartAreaFilter" onchange="updateChartDashboard()">
                                <option value="">Semua Area</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="storeScoreChart"></canvas>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="store-score-table" id="storeScoreTable">
                            <thead>
                                <tr>
                                    <th>Store</th>
                                    <th>Area</th>
                                    <th>Score</th>
                                    <th>Kategori</th>
                                    <th>Jumlah Visit</th>
                                </tr>
                            </thead>
                            <tbody id="storeScoreTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AS Dashboard Section (Visit Count Only) -->
            <div class="as-dashboard" id="asDashboard" style="display: none;">
                <div class="dashboard-header" style="margin-bottom: 15px;">
                    <h3>&#128202; Status Visit Store</h3>
                    <div class="dashboard-filter">
                        <select id="asChartMonthFilter" onchange="updateASDashboard()">
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <select id="asChartYearFilter" onchange="updateASDashboard()">
                        </select>
                        <button onclick="refreshASDashboard()" style="padding:8px 16px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px;">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="store-score-table" id="asStoreTable">
                        <thead>
                            <tr>
                                <th>Store</th>
                                <th>Area</th>
                                <th>Status</th>
                                <th>Jumlah Visit</th>
                            </tr>
                        </thead>
                        <tbody id="asStoreTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Progress Checklist -->
            <div class="progress-section form-section-hide">
                <div class="progress-header">
                    <span>Progress Checklist</span>
                    <span id="progressText">0 / 42 item</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Store Info -->
            <div class="card form-section-hide">
                <div class="card-title">
                    <div class="icon">&#127970;</div>
                    Informasi Store
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pilih Store *</label>
                        <select id="storeName" required>
                            <option value="">-- Pilih Store --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Visit</label>
                        <input type="date" id="visitDate">
                    </div>
                </div>
            </div>

            <!-- Bukti Visit / Check-in -->
            <div class="card visit-proof-section form-section-hide">
                <div class="visit-proof-title">
                    <span>&#128205;</span>
                    <strong>BUKTI VISIT (Check-in)</strong>
                </div>
                <div class="visit-proof-content">
                    <div class="visit-proof-photo">
                        <div class="visit-proof-photo-preview" id="visitProofPreview">
                            <span class="placeholder">&#128247;</span>
                        </div>
                        <label class="visit-proof-upload-btn">
                            &#128247; Ambil Foto
                            <input type="file" accept="image/*" capture="environment" onchange="uploadVisitProof(this.files)">
                        </label>
                    </div>
                    <div class="visit-proof-info">
                        <div class="visit-proof-item">
                            <div class="icon">&#128197;</div>
                            <div class="info">
                                <div class="label">Tanggal & Waktu</div>
                                <div class="value" id="visitProofTime">-</div>
                            </div>
                            <span class="status pending" id="visitProofTimeStatus">Menunggu</span>
                        </div>
                        <div class="visit-proof-item">
                            <div class="icon">&#128205;</div>
                            <div class="info">
                                <div class="label">Lokasi GPS</div>
                                <div class="value" id="visitProofLocation">-</div>
                            </div>
                            <button class="get-location-btn" id="getLocationBtn" onclick="getVisitLocation()">Ambil Lokasi</button>
                        </div>
                        <div class="visit-proof-item">
                            <div class="icon">&#9989;</div>
                            <div class="info">
                                <div class="label">Status Check-in</div>
                                <div class="value" id="visitProofStatus">Belum Check-in</div>
                            </div>
                            <span class="status pending" id="visitCheckinStatus">Pending</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checklist Sections -->
            <div class="card form-section-hide">
                <div class="card-title">
                    <div class="icon">&#9745;</div>
                    Checklist Penilaian
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#127978; STORE AMBIANCE</h3>
                        <div class="badge" id="badge-ambiance">0 / 10</div>
                    </div>
                    <div id="checklist-ambiance"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#128722; DISPLAY</h3>
                        <div class="badge" id="badge-display">0 / 8</div>
                    </div>
                    <div id="checklist-display"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#128203; STORE ADMINISTRASI</h3>
                        <div class="badge" id="badge-admin">0 / 8</div>
                    </div>
                    <div id="checklist-admin"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#129529; STORE CLEANING</h3>
                        <div class="badge" id="badge-cleaning">0 / 7</div>
                    </div>
                    <div id="checklist-cleaning"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#128105; SPG</h3>
                        <div class="badge" id="badge-spg">0 / 7</div>
                    </div>
                    <div id="checklist-spg"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <h3>&#128230; STOCK</h3>
                        <div class="badge" id="badge-stock">0 / 2</div>
                    </div>
                    <div id="checklist-stock"></div>
                </div>
            </div>

            <!-- Score Display -->
            <div class="card score-section form-section-hide" id="scoreSectionCard">
                <h2 id="scoreTitle">HASIL PENILAIAN</h2>
                <div class="score-display" id="scoreDisplay">0</div>
                <div class="score-label" id="scoreLabel">Belum Dinilai</div>
                <div class="score-details">
                    <div class="score-detail-item">
                        <div class="number" id="yesCount" style="color: #28a745;">0</div>
                        <div class="label">YES</div>
                    </div>
                    <div class="score-detail-item">
                        <div class="number" id="noCount" style="color: #dc3545;">0</div>
                        <div class="label">NO</div>
                    </div>
                    <div class="score-detail-item">
                        <div class="number" id="naCount" style="color: #6c757d;">0</div>
                        <div class="label">N/A</div>
                    </div>
                </div>

                <div class="comment-box">
                    <label>&#128221; Comment Improvement:</label>
                    <textarea id="commentImprovement" placeholder="Tuliskan catatan improvement untuk store..."></textarea>
                </div>
            </div>

            <!-- Visitor Name (hidden input for PDF) -->
            <input type="hidden" id="visitorName">
            <input type="hidden" id="spgFirstShift">
            <input type="hidden" id="spgSecondShift">

            <!-- Buttons -->
            <div class="button-group form-section-hide">
                <button class="btn-secondary" onclick="openArchive()">
                    &#128194; Lihat Arsip
                </button>
                <button class="btn-primary" onclick="saveVisit()">
                    &#128190; Simpan Visit
                </button>
            </div>
        </div>
    </div>

    <!-- Archive Detail Modal (for BM review) -->
    <div class="archive-detail-modal" id="archiveDetailModal">
        <div class="archive-detail-content">
            <div class="archive-detail-header">
                <h2>&#128203; Detail Visit</h2>
                <button class="modal-close" onclick="closeArchiveDetail()">&times;</button>
            </div>
            <div class="archive-detail-body" id="archiveDetailBody">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div class="rules-modal" id="rulesModal">
        <div class="rules-content">
            <div class="rules-header">
                <h2>&#128220; Rules Penilaian Visit</h2>
                <button class="modal-close" onclick="closeRules()">&times;</button>
            </div>
            <div class="rules-body">
                <div class="rules-section">
                    <h3>&#127919; Sistem Penilaian</h3>
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>Jawaban</th>
                                <th>Keterangan</th>
                                <th>Dihitung?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong style="color:#28a745;">YES</strong></td>
                                <td>Item sesuai standar</td>
                                <td>&#9989; Ya (sebagai benar)</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#dc3545;">NO</strong></td>
                                <td>Item tidak sesuai standar</td>
                                <td>&#9989; Ya (sebagai salah)</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#6c757d;">N/A</strong></td>
                                <td>Item tidak berlaku untuk store ini</td>
                                <td>&#10060; Tidak dihitung</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="rules-section">
                    <h3>&#128202; Rumus Perhitungan Score</h3>
                    <div class="rules-formula">
                        Score = (Jumlah YES &divide; (Jumlah YES + Jumlah NO)) &times; 100
                    </div>
                    <p><strong>Contoh:</strong> YES = 35, NO = 5, N/A = 2</p>
                    <div class="rules-formula">
                        Score = (35 &divide; 40) &times; 100 = <strong>87.5 â‰ˆ 88</strong>
                    </div>
                    <div class="rules-note">
                        <strong>&#128161; Catatan:</strong> N/A tidak mempengaruhi score sama sekali. Hanya YES dan NO yang masuk perhitungan.
                    </div>
                </div>

                <div class="rules-section">
                    <h3>&#127942; Kategori Score</h3>
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>Range Score</th>
                                <th>Kategori</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>80 - 100</strong></td>
                                <td><span class="score-badge good">Good</span></td>
                                <td>&#128994; Sangat Baik</td>
                            </tr>
                            <tr>
                                <td><strong>60 - 79</strong></td>
                                <td><span class="score-badge average">Average</span></td>
                                <td>&#128993; Cukup</td>
                            </tr>
                            <tr>
                                <td><strong>&lt; 60</strong></td>
                                <td><span class="score-badge poor">Poor</span></td>
                                <td>&#128308; Perlu Perbaikan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="rules-section">
                    <h3>&#128203; Total Item Checklist</h3>
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>Jumlah Item</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Store Ambiance</td><td>10 item</td></tr>
                            <tr><td>Display</td><td>8 item</td></tr>
                            <tr><td>Store Administrasi</td><td>8 item</td></tr>
                            <tr><td>Store Cleaning</td><td>7 item</td></tr>
                            <tr><td>SPG</td><td>7 item</td></tr>
                            <tr><td>Stock</td><td>2 item</td></tr>
                            <tr style="background:#1a1a2e;color:white;"><td><strong>TOTAL</strong></td><td><strong>42 item</strong></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminPanelModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>&#128736; Admin Panel - Kelola User</h2>
                <button class="modal-close" onclick="closeAdminPanel()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add User Form -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">&#10133; Tambah User Baru</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="newUsername" placeholder="Username" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="password" id="newPassword" placeholder="Password" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="text" id="newName" placeholder="Nama Lengkap" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="email" id="newEmail" placeholder="Email (untuk notifikasi)" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="newRole" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- Pilih Role --</option>
                            <option value="ho">Head Office</option>
                            <option value="bm">Branch Manager</option>
                            <option value="as">Area Supervisor</option>
                            <option value="admin">Admin</option>
                        </select>
                        <select id="newArea" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="all">Semua Area</option>
                        </select>
                        <button onclick="addNewUser()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Tambah</button>
                    </div>
                </div>

                <!-- User List -->
                <h3>&#128101; Daftar User</h3>
                <div id="userListAdmin" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Archive Modal -->
    <div class="modal" id="archiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>&#128194; Arsip Visit</h2>
                <button class="modal-close" onclick="closeArchive()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- BM Dashboard -->
                <div class="bm-dashboard" id="bmDashboard" style="display: none;">
                    <div class="bm-stat-card">
                        <div class="stat-number" id="bmStatTotal">0</div>
                        <div class="stat-label">Total Visit</div>
                    </div>
                    <div class="bm-stat-card good">
                        <div class="stat-number" id="bmStatGood">0</div>
                        <div class="stat-label">Good (80+)</div>
                    </div>
                    <div class="bm-stat-card warning">
                        <div class="stat-number" id="bmStatAvg">0</div>
                        <div class="stat-label">Average (60-79)</div>
                    </div>
                    <div class="bm-stat-card danger">
                        <div class="stat-number" id="bmStatPoor">0</div>
                        <div class="stat-label">Poor (&lt;60)</div>
                    </div>
                </div>

                <!-- Leaderboard for BM -->
                <div class="leaderboard" id="leaderboard" style="display: none;">
                    <h3>&#127942; Leaderboard AS - Bulan Ini</h3>
                    <div id="leaderboardList"></div>
                </div>

                <!-- Filters -->
                <div class="archive-filters">
                    <select id="filterArea" onchange="onAreaFilterChange()">
                        <option value="">Semua Area</option>
                    </select>
                    <select id="filterBM" onchange="onBMFilterChange()" style="display: none;">
                        <option value="">Semua BM</option>
                    </select>
                    <select id="filterAS" onchange="onASFilterChange()" style="display: none;">
                        <option value="">Semua AS</option>
                    </select>
                    <select id="filterStore" onchange="filterArchive()">
                        <option value="">Semua Store</option>
                    </select>
                    <select id="filterScore" onchange="filterArchive()">
                        <option value="">Semua Score</option>
                        <option value="good">Good (80-100)</option>
                        <option value="average">Average (60-79)</option>
                        <option value="poor">Poor (&lt;60)</option>
                    </select>
                </div>

                <!-- Bulk Delete Controls (Admin & BM only) -->
                <div class="bulk-delete-controls" id="bulkDeleteControls" style="display:none;">
                    <div style="display:flex; align-items:center; gap:15px; padding:10px 15px; background:linear-gradient(135deg,#f8f9fa,#e9ecef); border-radius:8px; margin-bottom:15px;">
                        <!-- Mode: Not selecting -->
                        <button id="startSelectBtn" onclick="startSelectMode()" style="padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
                            &#9745; Pilih untuk Hapus
                        </button>
                        <!-- Mode: Selecting -->
                        <div id="selectModeControls" style="display:none; align-items:center; gap:15px; width:100%;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:500;">
                                <input type="checkbox" id="selectAllArchive" onchange="toggleSelectAll()" style="width:18px; height:18px; cursor:pointer;">
                                Pilih Semua
                            </label>
                            <span id="selectedCount" style="color:#666; font-size:13px;">(0 dipilih)</span>
                            <button id="bulkDeleteBtn" onclick="bulkDeleteArchive()" style="margin-left:auto; padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; display:none;">
                                &#128465; Hapus Terpilih
                            </button>
                            <button onclick="cancelSelectMode()" style="padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>

                <div class="archive-list" id="archiveList"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // DATA CONFIGURATION
        // ========================================
        const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbx0klp-jMS_48vjuVgLKFWb0oYYXCYuqNfbKgZsjBO7laeBbRQfop57pEU6LfVwW7FX7g/exec';

        const AREA_DATA = {
            'bali1': { name: 'Bali 1', bm: 'Tomi', bmEmail: 'database@zuma.id', as: 'Wempy', asEmail: 'ilmiahwanwafiputra@gmail.com', stores: ['Bajera', 'Level 21', 'Jembrana', 'Penatih', 'Peguyangan', 'Tabanan', 'Monang Maning', 'Batubulan', 'Kapal'] },
            'bali2': { name: 'Bali 2', bm: 'Tomi', bmEmail: 'database@zuma.id', as: 'Erlang', stores: ['Living World', 'Icon Mall Bali', 'Dalung', 'Gianyar', 'Klungkung', 'Lippo Bali', 'Pemogan', 'Bangli', 'Karangasem'] },
            'bali3': { name: 'Bali 3', bm: 'Tomi', bmEmail: 'database@zuma.id', as: 'Manda', asEmail: 'wafi@zuma.id', stores: ['MBG', 'Kedonganan', 'Kesiman', 'Ubud', 'Peliatan', 'Panjer', 'Seririt', 'Singaraja', 'Lebah Peliatan', 'Uluwatu'] },
            'jatim': { name: 'Jawa Timur', bm: 'Kusdiyan', as: 'Ninik', stores: ['Lippo SDA', 'PTC', 'Galaxy', 'Matos', 'Lippo Batu', 'Tunjungan Plaza', 'Royal', 'Icon Mall Gresik', 'CITO', 'Sunrise Mall Mojokerto', 'MOG'] },
            'lombok': { name: 'Lombok', bm: 'Ariel', as: 'Lara Sati', stores: ['Mataram', 'Epicentrum'] },
            'jakarta': { name: 'Jakarta', bm: 'Christine', as: 'Irfa', stores: ['Pluit Village', 'MOI', 'LMP', 'Bintaro Xchange'] },
            'sulawesi': { name: 'Sulawesi', bm: null, as: 'Dian', stores: ['Mega Mall'], asHasBmAccess: true },
            'sumatera': { name: 'Sumatera', bm: 'Yusuf', as: null, stores: ['Ska Mall'], bmHasAsAccess: true },
            'batam': { name: 'Batam', bm: 'Arvina', as: null, stores: ['Nagoya Hills'], bmHasAsAccess: true }
        };

        // Target: 1 visit per store per month
        const VISIT_TARGET_PER_STORE = 1;

        const DEFAULT_USERS = [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator', area: 'all', email: 'admin@zuma.id' },
            { username: 'ho', password: 'ho123', role: 'ho', name: 'Head Office', area: 'all', email: 'ho@zuma.id' }
        ];

        // Generate users from AREA_DATA
        for (const [areaId, area] of Object.entries(AREA_DATA)) {
            if (area.as) {
                DEFAULT_USERS.push({
                    username: area.as.toLowerCase().replace(/\s+/g, ''),
                    password: 'as123',
                    role: 'as',
                    name: area.as,
                    area: areaId,
                    email: area.asEmail || ''
                });
            }
        }
        const bmAdded = new Set();
        for (const [areaId, area] of Object.entries(AREA_DATA)) {
            if (area.bm && !bmAdded.has(area.bm)) {
                const bmAreas = Object.entries(AREA_DATA).filter(([id, a]) => a.bm === area.bm).map(([id]) => id);
                // Get email from first area with this BM
                const bmEmail = Object.values(AREA_DATA).find(a => a.bm === area.bm)?.bmEmail || '';
                DEFAULT_USERS.push({
                    username: area.bm.toLowerCase().replace(/\s+/g, ''),
                    password: 'bm123',
                    role: 'bm',
                    name: area.bm,
                    area: bmAreas,
                    email: bmEmail
                });
                bmAdded.add(area.bm);
            }
        }

        const CHECKLIST_DATA = {
            ambiance: [
                { no: 1, text: "Layout toko diaplikasikan dengan benar seperti letak gondola, meja kasir, bench, meja display, signage, dll" },
                { no: 2, text: "AC menyala dengan baik & lubang AC tidak berdebu" },
                { no: 3, text: "Music menyala dengan baik playlist lagu sesuai VM guideline" },
                { no: 4, text: "CCTV aktif, semua camera beserta equipment menyala dengan baik" },
                { no: 5, text: "Tidak ada karton/box di area floor" },
                { no: 6, text: "Rollingdoor berfungsi dengan baik" },
                { no: 7, text: "Semua lampu menyala dengan baik" },
                { no: 8, text: "Keadaan toko bersih dan display rapi sesuai planogram/max stock" },
                { no: 9, text: "Memastikan WIFI aktif" },
                { no: 10, text: "Memastikan aliran listrik berfungsi dengan baik" }
            ],
            display: [
                { no: 11, text: "Produk best seller tersedia (T1-2-3) dan didisplay dengan baik" },
                { no: 12, text: "Produk New arrival/campaign tersedia dan didisplay dengan baik" },
                { no: 13, text: "Planogram toko terupdate based on sales mixed contribution per series" },
                { no: 14, text: "POP harga terpasang dengan benar" },
                { no: 15, text: "POP best seller terpasang dengan benar" },
                { no: 16, text: "POP new arrival terpasang dengan benar" },
                { no: 17, text: "Semua product terdapat hangtag (price tag)" },
                { no: 18, text: "Tidak ada product reject/kotor yang di display" }
            ],
            admin: [
                { no: 19, text: "Iseller dan Scanner berfungsi dengan baik" },
                { no: 20, text: "DNPB dan fisik barang diterima di hari yang sama dan di filing dengan baik" },
                { no: 21, text: "Mutasi antar store benar dan sesuai tujuan" },
                { no: 22, text: "Petty cash toko sesuai prosedure, fisik uang ada di toko sesuai data" },
                { no: 23, text: "Memastikan semua metode pembayaran (EDC, QR Code, Fintech) dapat digunakan dengan baik" },
                { no: 24, text: "SO harian dikerjakan sesuai schedule, menunjukkan bukti data/catatan yang tersimpan" },
                { no: 25, text: "Shrinkage SO sudah dilakukan penelusuran dan sudah ada adjustment oleh Ops team" },
                { no: 26, text: "Setoran tunai disetorkan 1 hari berikutnya" }
            ],
            cleaning: [
                { no: 27, text: "Lantai dalam keadaan bersih tidak berdebu" },
                { no: 28, text: "Produk tidak berdebu" },
                { no: 29, text: "Area cashier bersih dan rapi" },
                { no: 30, text: "Stock gudang rapi dan bersih" },
                { no: 31, text: "Fasilitas alat kebersihan tersedia (kanebo, lap, sapu, pel, dll)" },
                { no: 32, text: "Barang pribadi disimpan di laci dengan rapi (HP, tas, helm, dll)" },
                { no: 33, text: "Tempat sampah dan tissue tersedia" }
            ],
            spg: [
                { no: 34, text: "Grooming sesuai SOP (makeup, rambut, hijab)" },
                { no: 35, text: "Uniform bersih, rapi layak pakai & warna T-shirt sesuai dengan Jadwal pemakaian" },
                { no: 36, text: "SPG Mengerti Product knowledge/keunggulan produk" },
                { no: 37, text: "SPG melakukan Customer Service sesuai SOP Standar Customer service" },
                { no: 38, text: "Menguasai up selling, link selling dan cross selling" },
                { no: 39, text: "Menguasai handling objection & handling complain" },
                { no: 40, text: "Menginformasikan retur dan garansi" }
            ],
            stock: [
                { no: 41, text: "Stock yang ada di storage tersimpan rapi (store dengan storage)" },
                { no: 42, text: "Check random minimal 5 SKU dengan data yang ada di Accurate (request ke Ops team)" }
            ]
        };

        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentUser = null;
        let checklistAnswers = {};
        let checklistRemarks = {};
        let checklistPhotos = {};

        // Visit Proof Data
        let visitProofData = {
            photo: null,
            timestamp: null,
            location: null
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initUsers();
            checkLogin();
        });

        function initUsers() {
            let users = JSON.parse(localStorage.getItem('visit_users') || '[]');

            // Selalu pastikan DEFAULT_USERS ada di localStorage dan password ter-update
            let updated = false;
            DEFAULT_USERS.forEach(defaultUser => {
                const existingIdx = users.findIndex(u => u.username.toLowerCase() === defaultUser.username.toLowerCase());
                if (existingIdx === -1) {
                    // User belum ada, tambahkan
                    users.push(defaultUser);
                    updated = true;
                } else {
                    // User sudah ada, update password dan data lainnya dari default
                    users[existingIdx].password = defaultUser.password;
                    users[existingIdx].role = defaultUser.role;
                    users[existingIdx].name = defaultUser.name;
                    users[existingIdx].area = defaultUser.area;
                    if (defaultUser.email) users[existingIdx].email = defaultUser.email;
                    updated = true;
                }
            });

            if (updated || users.length === 0) {
                localStorage.setItem('visit_users', JSON.stringify(users));
            }
        }

        function checkLogin() {
            const savedUser = JSON.parse(localStorage.getItem('visit_current_user') || 'null');
            if (savedUser) {
                currentUser = savedUser;
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            initApp();
        }

        function doLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const user = users.find(u => u.username.toLowerCase() === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('visit_current_user', JSON.stringify(user));
                errorDiv.style.display = 'none';
                showApp();
            } else {
                errorDiv.textContent = 'Username atau password salah!';
                errorDiv.style.display = 'block';
            }
        }

        function doLogout() {
            if (confirm('Yakin ingin logout?')) {
                currentUser = null;
                localStorage.removeItem('visit_current_user');
                location.reload();
            }
        }

        async function initApp() {
            initUserDisplay();

            // Check special access flags
            const userArea = currentUser.area;
            const areaData = typeof userArea === 'string' ? AREA_DATA[userArea] : null;
            const asHasBmAccess = areaData && areaData.asHasBmAccess && currentUser.role === 'as';
            const bmHasAsAccess = areaData && areaData.bmHasAsAccess && currentUser.role === 'bm';

            // Set UI layout FIRST (before any async operations) to prevent flash of wrong layout
            if (currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'ho' || asHasBmAccess) {
                if (bmHasAsAccess) {
                    // BM dengan akses AS (Sumatera, Batam) - show AS form
                    document.getElementById('bmWelcome').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                } else {
                    // BM, Admin, HO, AS dengan akses BM - show BM view
                    document.querySelector('.container').classList.add('bm-view');
                    document.getElementById('bmWelcome').style.display = 'block';

                    // Set welcome message based on role
                    if (currentUser.role === 'admin') {
                        document.getElementById('welcomeTitle').innerHTML = '&#128736; Selamat Datang, Administrator!';
                        document.getElementById('welcomeDesc').innerHTML = 'Anda dapat melihat semua arsip visit, memberikan review, dan mengelola data.<br><button onclick="openAdminPanel()" style="margin-top:10px;padding:8px 15px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">&#128736; Kelola User</button>';
                    } else if (currentUser.role === 'ho') {
                        document.getElementById('welcomeTitle').innerHTML = '&#127970; Selamat Datang, Head Office!';
                        document.getElementById('welcomeDesc').textContent = 'Anda dapat memonitor semua visit dari seluruh area Indonesia.';
                    } else if (asHasBmAccess) {
                        document.getElementById('welcomeTitle').innerHTML = '&#128188; Selamat Datang, ' + currentUser.name + '!';
                        document.getElementById('welcomeDesc').textContent = 'Sebagai AS Sulawesi (tanpa BM), Anda dapat memonitor dan memberikan review visit.';
                    } else {
                        document.getElementById('welcomeTitle').innerHTML = '&#128188; Selamat Datang, Branch Manager!';
                        document.getElementById('welcomeDesc').textContent = 'Anda dapat melihat progress visit dari Area Supervisor dan memberikan review/feedback.';
                    }
                }
            } else {
                // Regular AS user - show AS form
                document.getElementById('dashboardSection').style.display = 'block';
            }

            // Now sync data from Google Sheets
            await initDashboard();

            // Initialize role-specific features after data is loaded
            if (currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'ho' || asHasBmAccess) {
                if (bmHasAsAccess) {
                    // BM dengan akses AS (Sumatera, Batam) tetap bisa input checklist
                    initStoreDropdown();
                    initChecklists();
                    hideScoreForAS();
                    document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
                    initASDashboard();
                } else {
                    // Initialize chart dashboard for BM/HO/Admin (data already synced)
                    initChartDashboard();
                }
            } else {
                // Regular AS user
                initStoreDropdown();
                initChecklists();
                hideScoreForAS();
                document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
                initASDashboard();
            }
        }

        // Sembunyikan skor untuk AS
        function hideScoreForAS() {
            if (currentUser.role === 'as') {
                // Sembunyikan kartu Avg Score di dashboard
                document.getElementById('dashCardScore').style.display = 'none';

                // Sembunyikan angka score dan label, tampilkan hanya YES/NO/NA count
                document.getElementById('scoreDisplay').style.display = 'none';
                document.getElementById('scoreLabel').style.display = 'none';
                document.getElementById('scoreTitle').textContent = 'RINGKASAN CHECKLIST';

                // Sembunyikan filter score di arsip
                document.getElementById('filterScore').style.display = 'none';
            }
        }

        function initUserDisplay() {
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.name;
            const roleNames = { 'admin': 'Administrator', 'bm': 'Branch Manager', 'as': 'Area Supervisor', 'ho': 'Head Office' };
            document.getElementById('userRole').textContent = roleNames[currentUser.role] || currentUser.role;
            document.getElementById('visitorName').value = currentUser.name;
        }

        function getUserStores() {
            let stores = [];
            if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                for (const area of Object.values(AREA_DATA)) {
                    area.stores.forEach(store => stores.push({ store, area: area.name }));
                }
            } else if (currentUser.role === 'bm') {
                const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                bmAreas.forEach(areaId => {
                    const area = AREA_DATA[areaId];
                    if (area) area.stores.forEach(store => stores.push({ store, area: area.name }));
                });
            } else if (currentUser.role === 'as') {
                const area = AREA_DATA[currentUser.area];
                if (area) area.stores.forEach(store => stores.push({ store, area: area.name }));
            }
            return stores;
        }

        function initStoreDropdown() {
            const select = document.getElementById('storeName');
            select.innerHTML = '<option value="">-- Pilih Store --</option>';
            const stores = getUserStores();
            const grouped = {};
            stores.forEach(s => {
                if (!grouped[s.area]) grouped[s.area] = [];
                grouped[s.area].push(s.store);
            });

            for (const [area, storeList] of Object.entries(grouped)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = area;
                storeList.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        }

        async function initDashboard() {
            const now = new Date();
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const currentMonthEl = document.getElementById('currentMonth');
            if (currentMonthEl) currentMonthEl.textContent = monthNames[now.getMonth()] + ' ' + now.getFullYear();

            // Show filters for BM, Admin, HO (if element exists)
            const filtersDiv = document.getElementById('storeStatusFilters');
            if (filtersDiv) {
                if (currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'ho') {
                    filtersDiv.style.display = 'flex';
                    populateDashFilters();
                } else {
                    filtersDiv.style.display = 'none';
                }
            }

            // Sync from Google Sheets first
            await syncFromGoogleSheets();

            updateDashboard();
        }

        async function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshDashBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'â³ Memuat...';
            }

            await syncFromGoogleSheets();
            updateDashboard();

            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'ðŸ”„ Refresh';
            }
        }

        function populateDashFilters() {
            const areaFilter = document.getElementById('dashFilterArea');
            const asFilter = document.getElementById('dashFilterAS');
            if (!areaFilter || !asFilter) return;

            // Populate Area filter
            let availableAreas = [];
            if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                availableAreas = Object.entries(AREA_DATA).map(([id, area]) => ({ id, name: area.name }));
            } else if (currentUser.role === 'bm') {
                const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                bmAreas.forEach(areaId => {
                    const area = AREA_DATA[areaId];
                    if (area) availableAreas.push({ id: areaId, name: area.name });
                });
            }
            // Sort: Bali 1, 2, 3 first
            availableAreas.sort((a, b) => {
                const order = ['bali1', 'bali2', 'bali3', 'jatim', 'lombok', 'jakarta', 'sulawesi', 'sumatera'];
                return order.indexOf(a.id) - order.indexOf(b.id);
            });
            areaFilter.innerHTML = '<option value="">Semua Area</option>' + availableAreas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            // Populate AS filter
            let availableAS = [];
            availableAreas.forEach(area => {
                const areaData = AREA_DATA[area.id];
                if (areaData && areaData.as) {
                    availableAS.push({ name: areaData.as, areaId: area.id, areaName: area.name });
                }
            });
            asFilter.innerHTML = '<option value="">Semua AS</option>' + availableAS.map(a => `<option value="${a.name}">${a.name} (${a.areaName})</option>`).join('');
        }

        function onDashAreaFilterChange() {
            const areaFilterEl = document.getElementById('dashFilterArea');
            const asFilter = document.getElementById('dashFilterAS');
            if (!areaFilterEl || !asFilter) return;

            const areaId = areaFilterEl.value;
            if (areaId) {
                // Show only AS for selected area
                const areaData = AREA_DATA[areaId];
                const asInArea = areaData && areaData.as ? [{ name: areaData.as, areaName: areaData.name }] : [];
                asFilter.innerHTML = '<option value="">Semua AS</option>' + asInArea.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            } else {
                // Show all AS
                populateDashFilters();
            }
            updateDashboard();
        }

        function updateDashboard() {
            const areaFilterEl = document.getElementById('dashFilterArea');
            const asFilterEl = document.getElementById('dashFilterAS');
            const areaFilter = areaFilterEl ? areaFilterEl.value : '';
            const asFilter = asFilterEl ? asFilterEl.value : '';

            // Get stores based on filter
            let stores = [];
            if (areaFilter) {
                // Filter by selected area
                const areaData = AREA_DATA[areaFilter];
                if (areaData) {
                    stores = areaData.stores.map(s => ({ store: s, area: areaData.name }));
                }
            } else if (asFilter) {
                // Filter by selected AS (find their area)
                for (const [areaId, area] of Object.entries(AREA_DATA)) {
                    if (area.as === asFilter) {
                        stores = area.stores.map(s => ({ store: s, area: area.name }));
                        break;
                    }
                }
            } else {
                // Show all stores for this user
                stores = getUserStores();
            }

            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthlyVisits = archive.filter(v => {
                const vDate = new Date(v.visitDate);
                return vDate.getMonth() === currentMonth && vDate.getFullYear() === currentYear;
            });

            // Filter by user role and selected filters
            const storeNames = stores.map(s => s.store);
            monthlyVisits = monthlyVisits.filter(v => storeNames.includes(v.storeName));

            if (asFilter) {
                monthlyVisits = monthlyVisits.filter(v => v.visitorName === asFilter);
            }

            // Calculate metrics
            const visitCount = monthlyVisits.length;
            const avgScore = monthlyVisits.length > 0 ? Math.round(monthlyVisits.reduce((sum, v) => sum + v.score, 0) / monthlyVisits.length) : 0;

            // Visited stores this month (unique)
            const visitedStores = [...new Set(monthlyVisits.map(v => v.storeName))];
            const pendingStores = stores.filter(s => !visitedStores.includes(s.store));

            // Coverage = unique stores visited / total stores
            const totalStores = stores.length;
            const coverage = totalStores > 0 ? Math.round((visitedStores.length / totalStores) * 100) : 0;

            // Update dashboard cards
            document.getElementById('dashVisitCount').textContent = visitCount;
            document.getElementById('dashVisitTarget').textContent = `dari ${totalStores} toko`;
            document.getElementById('dashProgress').textContent = `${coverage}%`;
            document.getElementById('dashCoverageSub').textContent = `${visitedStores.length}/${totalStores} Store`;
            document.getElementById('dashAvgScore').textContent = avgScore > 0 ? avgScore : '-';
            document.getElementById('dashScoreStatus').textContent = avgScore >= 80 ? 'Good' : avgScore >= 60 ? 'Average' : avgScore > 0 ? 'Poor' : '-';
            document.getElementById('dashPendingStore').textContent = pendingStores.length;

            // Progress ring (now based on coverage)
            const ring = document.getElementById('progressRing');
            const circumference = 2 * Math.PI * 25;
            const offset = circumference - (Math.min(coverage, 100) / 100) * circumference;
            ring.style.strokeDashoffset = offset;
            ring.classList.remove('warning', 'danger');
            if (coverage < 50) ring.classList.add('danger');
            else if (coverage < 80) ring.classList.add('warning');

            // Store status list (if element exists)
            const storeStatusBadge = document.getElementById('storeStatusBadge');
            const statusList = document.getElementById('storeStatusList');
            if (storeStatusBadge) {
                storeStatusBadge.textContent = `${visitedStores.length}/${stores.length} Store`;
            }
            if (statusList) {
                statusList.innerHTML = stores.map(s => {
                    const isVisited = visitedStores.includes(s.store);
                    const showArea = (currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'ho') && !areaFilter;
                    return `<div class="store-status-item ${isVisited ? 'visited' : 'not-visited'}">
                        <span class="status-icon">${isVisited ? '&#9989;' : '&#10060;'}</span>
                        <span>${s.store}${showArea ? ' <small style="opacity:0.7;">(' + s.area + ')</small>' : ''}</span>
                    </div>`;
                }).join('');
            }
        }

        // ========================================
        // CHART DASHBOARD (BM/HO)
        // ========================================
        let storeScoreChartInstance = null;

        function initChartDashboard() {
            if (currentUser.role !== 'bm' && currentUser.role !== 'ho' && currentUser.role !== 'admin') return;

            const now = new Date();

            // Set current month as selected
            const monthFilter = document.getElementById('chartMonthFilter');
            monthFilter.value = String(now.getMonth() + 1);

            // Populate year filter (current year and 2 years back)
            const yearFilter = document.getElementById('chartYearFilter');
            const currentYear = now.getFullYear();
            let yearOptions = '';
            for (let y = currentYear; y >= currentYear - 2; y--) {
                const selected = y === currentYear ? 'selected' : '';
                yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
            }
            yearFilter.innerHTML = yearOptions;

            // Populate area filter
            const areaFilter = document.getElementById('chartAreaFilter');
            let availableAreas = [];
            if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                availableAreas = Object.entries(AREA_DATA).map(([id, area]) => ({ id, name: area.name }));
            } else if (currentUser.role === 'bm') {
                const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                bmAreas.forEach(areaId => {
                    const area = AREA_DATA[areaId];
                    if (area) availableAreas.push({ id: areaId, name: area.name });
                });
            }
            availableAreas.sort((a, b) => {
                const order = ['bali1', 'bali2', 'bali3', 'jatim', 'lombok', 'jakarta', 'sulawesi', 'sumatera', 'batam'];
                return order.indexOf(a.id) - order.indexOf(b.id);
            });
            areaFilter.innerHTML = '<option value="">Semua Area</option>' + availableAreas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            updateChartDashboard();
        }

        function updateChartDashboard() {
            const month = parseInt(document.getElementById('chartMonthFilter').value);
            const year = parseInt(document.getElementById('chartYearFilter').value);
            const areaValue = document.getElementById('chartAreaFilter').value;

            if (!month || !year) return;
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');

            // Get stores based on filter
            let stores = [];
            if (areaValue) {
                const areaData = AREA_DATA[areaValue];
                if (areaData) {
                    stores = areaData.stores.map(s => ({ store: s, area: areaData.name, areaId: areaValue }));
                }
            } else {
                // All stores for this user
                if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                    for (const [areaId, area] of Object.entries(AREA_DATA)) {
                        area.stores.forEach(s => stores.push({ store: s, area: area.name, areaId }));
                    }
                } else if (currentUser.role === 'bm') {
                    const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                    bmAreas.forEach(areaId => {
                        const area = AREA_DATA[areaId];
                        if (area) {
                            area.stores.forEach(s => stores.push({ store: s, area: area.name, areaId }));
                        }
                    });
                }
            }

            // Filter visits by selected month
            const monthlyVisits = archive.filter(v => {
                const vDate = new Date(v.visitDate);
                return vDate.getMonth() === (month - 1) && vDate.getFullYear() === year;
            });

            // Calculate score per store
            const storeData = stores.map(s => {
                const storeVisits = monthlyVisits.filter(v => v.storeName === s.store);
                const visitCount = storeVisits.length;
                const avgScore = visitCount > 0 ? Math.round(storeVisits.reduce((sum, v) => sum + (v.score || 0), 0) / visitCount) : null;
                const lastVisit = storeVisits.length > 0 ? storeVisits[0] : null;
                return {
                    ...s,
                    visitCount,
                    avgScore,
                    lastVisit,
                    category: avgScore === null ? 'none' : avgScore >= 80 ? 'good' : avgScore >= 60 ? 'average' : 'poor'
                };
            });

            // Sort by score (null at end)
            storeData.sort((a, b) => {
                if (a.avgScore === null && b.avgScore === null) return 0;
                if (a.avgScore === null) return 1;
                if (b.avgScore === null) return -1;
                return b.avgScore - a.avgScore;
            });

            // Update chart
            renderStoreScoreChart(storeData);

            // Update table
            renderStoreScoreTable(storeData);
        }

        function renderStoreScoreChart(storeData) {
            const ctx = document.getElementById('storeScoreChart').getContext('2d');

            if (storeScoreChartInstance) {
                storeScoreChartInstance.destroy();
            }

            const labels = storeData.map(s => s.store);
            const scores = storeData.map(s => s.avgScore || 0);
            const colors = storeData.map(s => {
                if (s.avgScore === null) return 'rgba(108, 117, 125, 0.7)';
                if (s.avgScore >= 80) return 'rgba(40, 167, 69, 0.8)';
                if (s.avgScore >= 60) return 'rgba(255, 193, 7, 0.8)';
                return 'rgba(220, 53, 69, 0.8)';
            });

            storeScoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1').replace('0.7', '1')),
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const store = storeData[context.dataIndex];
                                    if (store.avgScore === null) return 'Belum ada visit';
                                    return `Score: ${store.avgScore}% (${store.visitCount}x visit)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function renderStoreScoreTable(storeData) {
            const tbody = document.getElementById('storeScoreTableBody');

            if (storeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;opacity:0.6;">Tidak ada data</td></tr>';
                return;
            }

            tbody.innerHTML = storeData.map(s => {
                const scoreText = s.avgScore !== null ? `${s.avgScore}%` : '-';
                const categoryLabel = s.category === 'good' ? 'Good' : s.category === 'average' ? 'Average' : s.category === 'poor' ? 'Poor' : 'Belum Visit';

                return `<tr>
                    <td><strong>${s.store}</strong></td>
                    <td>${s.area}</td>
                    <td><strong>${scoreText}</strong></td>
                    <td><span class="score-badge ${s.category}">${categoryLabel}</span></td>
                    <td><span class="visit-count-badge">${s.visitCount}x</span></td>
                </tr>`;
            }).join('');
        }

        // ========================================
        // AS DASHBOARD FUNCTIONS (Visit Count Only)
        // ========================================
        function initASDashboard() {
            // For AS users and BM with AS access (Sumatera, Batam)
            const userArea = currentUser.area;
            const areaData = typeof userArea === 'string' ? AREA_DATA[userArea] : null;
            const bmHasAsAccess = areaData && areaData.bmHasAsAccess && currentUser.role === 'bm';

            if (currentUser.role !== 'as' && !bmHasAsAccess) return;

            const now = new Date();

            // Set current month as selected
            const monthFilter = document.getElementById('asChartMonthFilter');
            if (monthFilter) monthFilter.value = String(now.getMonth() + 1);

            // Populate year filter
            const yearFilter = document.getElementById('asChartYearFilter');
            if (yearFilter) {
                const currentYear = now.getFullYear();
                let yearOptions = '';
                for (let y = currentYear; y >= currentYear - 2; y--) {
                    const selected = y === currentYear ? 'selected' : '';
                    yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
                }
                yearFilter.innerHTML = yearOptions;
            }

            // Show AS Dashboard
            document.getElementById('asDashboard').style.display = 'block';

            updateASDashboard();
        }

        async function refreshASDashboard() {
            await syncFromGoogleSheets();
            updateASDashboard();
        }

        function updateASDashboard() {
            const monthEl = document.getElementById('asChartMonthFilter');
            const yearEl = document.getElementById('asChartYearFilter');
            if (!monthEl || !yearEl) return;

            const month = parseInt(monthEl.value);
            const year = parseInt(yearEl.value);

            if (!month || !year) return;

            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');

            // Get stores for AS's area
            let stores = [];
            const area = AREA_DATA[currentUser.area];
            if (area) {
                stores = area.stores.map(s => ({ store: s, area: area.name }));
            }

            // Filter visits by selected month and AS's name
            const monthlyVisits = archive.filter(v => {
                const vDate = new Date(v.visitDate);
                return vDate.getMonth() === (month - 1) &&
                       vDate.getFullYear() === year &&
                       v.visitorName === currentUser.name;
            });

            // Calculate visit count per store
            const storeData = stores.map(s => {
                const storeVisits = monthlyVisits.filter(v => v.storeName === s.store);
                const visitCount = storeVisits.length;
                return {
                    ...s,
                    visitCount,
                    status: visitCount > 0 ? 'visited' : 'pending'
                };
            });

            // Sort: visited first, then by store name
            storeData.sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'visited' ? -1 : 1;
                }
                return a.store.localeCompare(b.store);
            });

            // Render table
            renderASStoreTable(storeData);
        }

        function renderASStoreTable(storeData) {
            const tbody = document.getElementById('asStoreTableBody');
            if (!tbody) return;

            if (storeData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;opacity:0.6;">Tidak ada data</td></tr>';
                return;
            }

            tbody.innerHTML = storeData.map(s => {
                const statusLabel = s.status === 'visited' ? 'Sudah Visit' : 'Belum Visit';
                const statusClass = s.status === 'visited' ? 'good' : 'none';
                const visitText = s.visitCount > 0 ? `${s.visitCount}x` : '-';

                return `<tr>
                    <td><strong>${s.store}</strong></td>
                    <td>${s.area}</td>
                    <td><span class="score-badge ${statusClass}">${statusLabel}</span></td>
                    <td style="text-align:center;"><span class="visit-count-badge">${visitText}</span></td>
                </tr>`;
            }).join('');
        }

        function initChecklists() {
            for (const [category, items] of Object.entries(CHECKLIST_DATA)) {
                const container = document.getElementById(`checklist-${category}`);
                container.innerHTML = '';
                items.forEach(item => container.appendChild(createChecklistItem(item, category)));
            }
        }

        function createChecklistItem(item, category) {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.id = `item-${item.no}`;
            div.innerHTML = `
                <div class="checklist-item-row">
                    <div class="checklist-item-main">
                        <div class="checklist-item-header">
                            <div class="checklist-number">${item.no}</div>
                            <div class="checklist-text">${item.text}</div>
                            <div class="checklist-buttons">
                                <button class="btn-yes" onclick="setAnswer(${item.no}, 'yes', '${category}')">YES</button>
                                <button class="btn-no" onclick="setAnswer(${item.no}, 'no', '${category}')">NO</button>
                                <button class="btn-na" onclick="setAnswer(${item.no}, 'na', '${category}')">N/A</button>
                            </div>
                        </div>
                        <div class="checklist-extra" id="extra-${item.no}">
                            <textarea placeholder="Remarks / Catatan..." onchange="setRemarks(${item.no}, this.value)"></textarea>
                        </div>
                    </div>
                    <div class="checklist-item-photo">
                        <label class="checklist-photo-btn" id="photo-btn-${item.no}">
                            <span class="camera-icon">&#128247;</span>
                            <span class="photo-text">Foto</span>
                            <input type="file" accept="image/*" capture="environment" onchange="uploadPhoto(${item.no}, this.files)">
                        </label>
                    </div>
                </div>
            `;
            return div;
        }

        // Signature pads removed - no longer needed

        // ========================================
        // CHECKLIST FUNCTIONS
        // ========================================
        function setAnswer(no, answer, category) {
            checklistAnswers[no] = answer;
            const item = document.getElementById(`item-${no}`);
            item.classList.remove('yes', 'no');
            if (answer === 'yes') item.classList.add('yes');
            if (answer === 'no') item.classList.add('no');

            item.querySelectorAll('.btn-yes, .btn-no, .btn-na').forEach(btn => btn.classList.remove('active'));
            item.querySelector(`.btn-${answer}`).classList.add('active');

            const extra = document.getElementById(`extra-${no}`);
            extra.classList.toggle('show', answer === 'no');

            updateProgress();
            updateScore();
            updateCategoryBadge(category);
        }

        function setRemarks(no, value) { checklistRemarks[no] = value; }

        function uploadPhoto(no, files) {
            if (!checklistPhotos[no]) checklistPhotos[no] = [];
            const btn = document.getElementById(`photo-btn-${no}`);
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    checklistPhotos[no].push(e.target.result);
                    // Update button to show photo
                    btn.innerHTML = `<img src="${e.target.result}">`;
                    btn.classList.add('has-photo');
                };
                reader.readAsDataURL(file);
            });
        }

        // ========================================
        // VISIT PROOF FUNCTIONS
        // ========================================
        function uploadVisitProof(files) {
            if (files.length === 0) return;
            const file = files[0];
            const reader = new FileReader();
            reader.onload = e => {
                visitProofData.photo = e.target.result;
                visitProofData.timestamp = new Date().toISOString();

                // Update preview
                document.getElementById('visitProofPreview').innerHTML = `<img src="${e.target.result}">`;

                // Update timestamp display
                const dt = new Date(visitProofData.timestamp);
                const timeStr = dt.toLocaleDateString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                }) + ' ' + dt.toLocaleTimeString('id-ID');
                document.getElementById('visitProofTime').textContent = timeStr;
                document.getElementById('visitProofTimeStatus').textContent = 'OK';
                document.getElementById('visitProofTimeStatus').className = 'status success';

                updateVisitProofStatus();
            };
            reader.readAsDataURL(file);
        }

        function getVisitLocation() {
            const btn = document.getElementById('getLocationBtn');
            const locationEl = document.getElementById('visitProofLocation');

            if (!navigator.geolocation) {
                alert('Geolocation tidak didukung browser Anda');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Mengambil...';
            locationEl.textContent = 'Mengambil lokasi...';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);

                    // Get address from coordinates (reverse geocoding)
                    let address = '';
                    try {
                        locationEl.textContent = 'Mengambil alamat...';
                        const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                            headers: { 'Accept-Language': 'id' }
                        });
                        const geoData = await geoResponse.json();
                        if (geoData && geoData.display_name) {
                            address = geoData.display_name;
                        }
                    } catch (e) {
                        console.log('Geocoding error:', e);
                    }

                    visitProofData.location = { lat, lng, accuracy: position.coords.accuracy, address };

                    // Display address and coordinates
                    if (address) {
                        locationEl.innerHTML = `
                            <div style="font-size: 13px; margin-bottom: 5px;">ðŸ“ ${address}</div>
                            <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color: #90caf9; font-size: 12px;">${lat}, ${lng} â†—</a>
                        `;
                    } else {
                        locationEl.innerHTML = `<a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color: #90caf9;">${lat}, ${lng}</a>`;
                    }

                    btn.textContent = 'OK';
                    btn.className = 'status success';
                    btn.disabled = true;

                    updateVisitProofStatus();
                },
                (error) => {
                    let msg = 'Gagal mendapatkan lokasi';
                    if (error.code === 1) msg = 'Akses lokasi ditolak';
                    else if (error.code === 2) msg = 'Lokasi tidak tersedia';
                    else if (error.code === 3) msg = 'Timeout';

                    locationEl.textContent = msg;
                    btn.textContent = 'Coba Lagi';
                    btn.disabled = false;
                    btn.className = 'get-location-btn';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function updateVisitProofStatus() {
            const statusEl = document.getElementById('visitProofStatus');
            const statusBadge = document.getElementById('visitCheckinStatus');

            if (visitProofData.photo && visitProofData.location) {
                statusEl.textContent = 'Check-in Berhasil';
                statusBadge.textContent = 'OK';
                statusBadge.className = 'status success';
            } else if (visitProofData.photo || visitProofData.location) {
                statusEl.textContent = 'Lengkapi data';
                statusBadge.textContent = 'Incomplete';
                statusBadge.className = 'status pending';
            } else {
                statusEl.textContent = 'Belum Check-in';
                statusBadge.textContent = 'Pending';
                statusBadge.className = 'status pending';
            }
        }

        function updateProgress() {
            const answered = Object.keys(checklistAnswers).length;
            document.getElementById('progressText').textContent = `${answered} / 42 item`;
            document.getElementById('progressFill').style.width = `${(answered / 42) * 100}%`;
        }

        function updateScore() {
            let yesCount = 0, noCount = 0, naCount = 0;
            Object.values(checklistAnswers).forEach(a => {
                if (a === 'yes') yesCount++;
                else if (a === 'no') noCount++;
                else if (a === 'na') naCount++;
            });

            const total = yesCount + noCount;
            const score = total > 0 ? Math.round((yesCount / total) * 100) : 0;

            document.getElementById('yesCount').textContent = yesCount;
            document.getElementById('noCount').textContent = noCount;
            document.getElementById('naCount').textContent = naCount;

            const scoreDisplay = document.getElementById('scoreDisplay');
            const scoreLabel = document.getElementById('scoreLabel');
            scoreDisplay.textContent = score;
            scoreDisplay.className = 'score-display';
            scoreLabel.className = 'score-label';

            if (score >= 80) { scoreDisplay.classList.add('good'); scoreLabel.classList.add('good'); scoreLabel.textContent = 'GOOD'; }
            else if (score >= 60) { scoreDisplay.classList.add('average'); scoreLabel.classList.add('average'); scoreLabel.textContent = 'AVERAGE'; }
            else if (total > 0) { scoreDisplay.classList.add('poor'); scoreLabel.classList.add('poor'); scoreLabel.textContent = 'POOR'; }
            else { scoreLabel.textContent = 'Belum Dinilai'; }
        }

        function updateCategoryBadge(category) {
            const items = CHECKLIST_DATA[category];
            const count = items.filter(item => checklistAnswers[item.no]).length;
            document.getElementById(`badge-${category}`).textContent = `${count} / ${items.length}`;
        }

        // ========================================
        // ARCHIVE FUNCTIONS
        // ========================================
        async function openArchive() {
            // Show loading
            document.getElementById('archiveModal').classList.add('show');
            document.getElementById('archiveList').innerHTML = '<p style="text-align:center;padding:20px;">Memuat data dari server...</p>';

            // Sync from Google Sheets first
            await syncFromGoogleSheets();

            // Then load archive
            loadArchive();
        }

        // Sync data from Google Sheets to localStorage
        async function syncFromGoogleSheets() {
            try {
                const response = await fetch(GOOGLE_SHEETS_API + '?action=get');
                const result = await response.json();

                if (result.success && result.data) {
                    const sheetsData = result.data;

                    // Get list of all formNo from Google Sheets
                    const sheetsFormNos = sheetsData.map(item => item['Form No']).filter(Boolean);

                    // Build new archive from Google Sheets data
                    const newArchive = [];

                    sheetsData.forEach(sheetItem => {
                        const formNo = sheetItem['Form No'];
                        if (!formNo) return;

                        const bmReviewText = sheetItem['BM Riview'] || sheetItem['BM Review'] || '';
                        newArchive.push({
                            formNo: formNo,
                            storeName: sheetItem['Store Name'] || '',
                            visitDate: sheetItem['Visit Date'] || '',
                            score: sheetItem['Score'] || 0,
                            visitorName: sheetItem['Visitor Name'] || '',
                            areaName: sheetItem['Area Name'] || '',
                            comment: sheetItem['Comment'] || '',
                            createdAt: sheetItem['Created At'] || '',
                            bmReview: bmReviewText ? {
                                comment: bmReviewText,
                                reviewedAt: sheetItem['BM Riview Date'] || sheetItem['BM Review Date'] || ''
                            } : null,
                            pdfLink: sheetItem['PDFLink'] || '',
                            answers: {},
                            fromSheets: true
                        });
                    });

                    // Sort by date descending
                    newArchive.sort((a, b) => new Date(b.createdAt || b.visitDate) - new Date(a.createdAt || a.visitDate));

                    // Replace localStorage with fresh data from Google Sheets
                    localStorage.setItem('visit_archive', JSON.stringify(newArchive));
                    console.log('Synced ' + sheetsData.length + ' records from Google Sheets (full refresh)');
                }
            } catch (e) {
                console.log('Sync error:', e);
            }
        }

        function closeArchive() {
            document.getElementById('archiveModal').classList.remove('show');
        }

        // ========================================
        // RULES MODAL FUNCTIONS
        // ========================================
        function openRules() {
            document.getElementById('rulesModal').classList.add('show');
        }

        function closeRules() {
            document.getElementById('rulesModal').classList.remove('show');
        }

        // Close rules modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'rulesModal') closeRules();
        });

        // ========================================
        // ADMIN PANEL FUNCTIONS
        // ========================================
        function openAdminPanel() {
            document.getElementById('adminPanelModal').classList.add('show');
            loadUserListAdmin();
            populateAreaDropdown();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanelModal').classList.remove('show');
        }

        function populateAreaDropdown() {
            const select = document.getElementById('newArea');
            select.innerHTML = '<option value="all">Semua Area</option>';
            for (const [areaId, area] of Object.entries(AREA_DATA)) {
                const option = document.createElement('option');
                option.value = areaId;
                option.textContent = area.name;
                select.appendChild(option);
            }
        }

        function loadUserListAdmin() {
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const container = document.getElementById('userListAdmin');

            if (users.length === 0) {
                container.innerHTML = '<p>Tidak ada user.</p>';
                return;
            }

            let html = '<table style="width:100%;border-collapse:collapse;">';
            html += '<thead><tr style="background:#f8f9fa;"><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">Username</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">Nama</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">Email</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">Role</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">Area</th><th style="padding:10px;text-align:center;border-bottom:2px solid #dee2e6;">Aksi</th></tr></thead><tbody>';

            const roleLabels = { 'admin': 'Administrator', 'bm': 'Branch Manager', 'as': 'Area Supervisor', 'ho': 'Head Office' };

            users.forEach(user => {
                const areaLabel = user.area === 'all' ? 'Semua' : (Array.isArray(user.area) ? user.area.map(a => AREA_DATA[a]?.name || a).join(', ') : (AREA_DATA[user.area]?.name || user.area));
                const userEmail = user.email || '-';

                html += `<tr style="border-bottom:1px solid #dee2e6;">
                    <td style="padding:10px;">${user.username}</td>
                    <td style="padding:10px;">${user.name}</td>
                    <td style="padding:10px;font-size:12px;">${userEmail}</td>
                    <td style="padding:10px;"><span style="background:${user.role === 'admin' ? '#dc3545' : user.role === 'ho' ? '#6f42c1' : user.role === 'bm' ? '#007bff' : '#28a745'};color:white;padding:2px 8px;border-radius:10px;font-size:12px;">${roleLabels[user.role] || user.role}</span></td>
                    <td style="padding:10px;font-size:12px;">${areaLabel}</td>
                    <td style="padding:10px;text-align:center;">
                        <button onclick="editUser('${user.username}')" style="padding:5px 10px;background:#6c757d;color:white;border:none;border-radius:3px;cursor:pointer;margin-right:5px;" title="Edit User">&#9998;</button>
                        <button onclick="changeUserEmail('${user.username}')" style="padding:5px 10px;background:#17a2b8;color:white;border:none;border-radius:3px;cursor:pointer;margin-right:5px;" title="Ubah Email">&#9993;</button>
                        <button onclick="changeUserPassword('${user.username}')" style="padding:5px 10px;background:#ffc107;color:#000;border:none;border-radius:3px;cursor:pointer;margin-right:5px;" title="Ubah Password">&#128273;</button>
                        <button onclick="deleteUser('${user.username}')" style="padding:5px 10px;background:#dc3545;color:white;border:none;border-radius:3px;cursor:pointer;" title="Hapus">&#128465;</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function addNewUser() {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newPassword').value;
            const name = document.getElementById('newName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const role = document.getElementById('newRole').value;
            const area = document.getElementById('newArea').value;

            if (!username || !password || !name || !role) {
                alert('Username, password, nama, dan role harus diisi!');
                return;
            }

            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');

            if (users.some(u => u.username === username)) {
                alert('Username sudah ada!');
                return;
            }

            users.push({
                username,
                password,
                name,
                email: email || '',
                role,
                area: role === 'ho' || role === 'admin' ? 'all' : area
            });
            localStorage.setItem('visit_users', JSON.stringify(users));

            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newRole').value = '';
            document.getElementById('newArea').value = 'all';

            alert('User berhasil ditambahkan!');
            loadUserListAdmin();
        }

        function changeUserEmail(username) {
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const user = users.find(u => u.username === username);
            const currentEmail = user ? (user.email || '') : '';

            const newEmail = prompt('Masukkan email untuk ' + username + ':', currentEmail);
            if (newEmail === null) return; // cancelled

            const userIndex = users.findIndex(u => u.username === username);
            if (userIndex === -1) {
                alert('User tidak ditemukan!');
                return;
            }

            users[userIndex].email = newEmail;
            localStorage.setItem('visit_users', JSON.stringify(users));
            alert('Email berhasil diubah!');
            loadUserListAdmin();
        }

        function changeUserPassword(username) {
            const newPassword = prompt('Masukkan password baru untuk ' + username + ':');
            if (!newPassword) return;

            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const userIndex = users.findIndex(u => u.username === username);

            if (userIndex === -1) {
                alert('User tidak ditemukan!');
                return;
            }

            users[userIndex].password = newPassword;
            localStorage.setItem('visit_users', JSON.stringify(users));
            alert('Password berhasil diubah!');
        }

        function deleteUser(username) {
            if (!confirm('Hapus user ' + username + '?')) return;

            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const filtered = users.filter(u => u.username !== username);
            localStorage.setItem('visit_users', JSON.stringify(filtered));

            alert('User berhasil dihapus!');
            loadUserListAdmin();
        }

        function editUser(username) {
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const userIndex = users.findIndex(u => u.username === username);

            if (userIndex === -1) {
                alert('User tidak ditemukan!');
                return;
            }

            const user = users[userIndex];

            // Prompt for new username
            const newUsername = prompt('Edit Username (kosongkan jika tidak ingin mengubah):', user.username);
            if (newUsername === null) return; // cancelled

            // Prompt for new name
            const newName = prompt('Edit Nama (kosongkan jika tidak ingin mengubah):', user.name);
            if (newName === null) return; // cancelled

            // Check if new username already exists (if changed)
            const finalUsername = newUsername.trim().toLowerCase() || user.username;
            const finalName = newName.trim() || user.name;

            if (finalUsername !== user.username && users.some(u => u.username === finalUsername)) {
                alert('Username sudah digunakan oleh user lain!');
                return;
            }

            // Update user data
            users[userIndex].username = finalUsername;
            users[userIndex].name = finalName;
            localStorage.setItem('visit_users', JSON.stringify(users));

            alert('User berhasil diupdate!');
            loadUserListAdmin();
        }

        // Close admin panel when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'adminPanelModal') closeAdminPanel();
        });

        // Helper: get area name for a store
        function getAreaForStore(storeName) {
            for (const [areaId, area] of Object.entries(AREA_DATA)) {
                if (area.stores.includes(storeName)) {
                    return { id: areaId, name: area.name };
                }
            }
            return null;
        }

        // Helper: get user by username
        function getUserByUsername(username) {
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            return users.find(u => u.username === username.toLowerCase());
        }

        // Helper: get user by name
        function getUserByName(name) {
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            return users.find(u => u.name === name);
        }

        // Helper: get BM email for a store's area
        function getBMEmailForStore(storeName) {
            const area = getAreaForStore(storeName);
            if (!area) return null;

            const areaData = AREA_DATA[area.id];
            if (!areaData || !areaData.bm) return null;

            // Find BM user by name
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const bmUser = users.find(u => u.name === areaData.bm && u.role === 'bm');
            return bmUser ? bmUser.email : null;
        }

        // Helper: get AS email for a store's area
        function getASEmailForStore(storeName) {
            const area = getAreaForStore(storeName);
            if (!area) return null;

            const areaData = AREA_DATA[area.id];
            if (!areaData || !areaData.as) return null;

            // Find AS user by name
            const users = JSON.parse(localStorage.getItem('visit_users') || '[]');
            const asUser = users.find(u => u.name === areaData.as && u.role === 'as');
            return asUser ? asUser.email : null;
        }

        // Send email notification via Google Apps Script
        async function sendEmailNotification(type, data) {
            try {
                const payload = {
                    action: 'sendEmail',
                    type: type, // 'visit' or 'review'
                    ...data
                };

                const response = await fetch(GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Email notification result:', result);
                return result;
            } catch (error) {
                console.error('Failed to send email notification:', error);
                return { success: false, error: error.message };
            }
        }

        // Helper: get stores for an area
        function getStoresForArea(areaId) {
            return AREA_DATA[areaId] ? AREA_DATA[areaId].stores : [];
        }

        function loadArchive() {
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const stores = getUserStores();
            const storeNames = stores.map(s => s.store);

            let filtered = archive;
            if (currentUser.role === 'as') {
                filtered = archive.filter(a => a.visitorName === currentUser.name);
            } else if (currentUser.role === 'bm') {
                filtered = archive.filter(a => storeNames.includes(a.storeName));
            }

            // BM Dashboard & Leaderboard
            const bmDashboard = document.getElementById('bmDashboard');
            const leaderboard = document.getElementById('leaderboard');
            const filterAS = document.getElementById('filterAS');
            const filterBM = document.getElementById('filterBM');
            const filterArea = document.getElementById('filterArea');

            if (currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'ho') {
                bmDashboard.style.display = 'grid';
                leaderboard.style.display = 'block';
                filterBM.style.display = 'block';
                filterAS.style.display = 'block';
                filterArea.style.display = 'block';

                document.getElementById('bmStatTotal').textContent = filtered.length;
                document.getElementById('bmStatGood').textContent = filtered.filter(a => a.score >= 80).length;
                document.getElementById('bmStatAvg').textContent = filtered.filter(a => a.score >= 60 && a.score < 80).length;
                document.getElementById('bmStatPoor').textContent = filtered.filter(a => a.score < 60).length;

                // Leaderboard
                const now = new Date();
                const monthlyVisits = filtered.filter(v => {
                    const d = new Date(v.visitDate);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });

                const asStats = {};
                monthlyVisits.forEach(v => {
                    if (!asStats[v.visitorName]) asStats[v.visitorName] = { visits: 0, totalScore: 0 };
                    asStats[v.visitorName].visits++;
                    asStats[v.visitorName].totalScore += v.score;
                });

                const leaderboardData = Object.entries(asStats).map(([name, stats]) => ({
                    name,
                    visits: stats.visits,
                    avgScore: Math.round(stats.totalScore / stats.visits)
                })).sort((a, b) => b.avgScore - a.avgScore || b.visits - a.visits);

                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = leaderboardData.slice(0, 5).map((item, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return `<div class="leaderboard-item ${rankClass}">
                        <div class="leaderboard-rank">${i + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${item.name}</div>
                            <div class="leaderboard-stats">${item.visits} visit bulan ini</div>
                        </div>
                        <div class="leaderboard-score">${item.avgScore}</div>
                    </div>`;
                }).join('') || '<p style="color:#666;text-align:center;">Belum ada data</p>';

                // Area filter - show ALL areas managed by BM (not just visited)
                let availableAreas = [];
                if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                    // Admin/HO sees all areas
                    availableAreas = Object.entries(AREA_DATA).map(([id, area]) => ({ id, name: area.name }));
                } else if (currentUser.role === 'bm') {
                    // BM sees their managed areas
                    const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                    bmAreas.forEach(areaId => {
                        const area = AREA_DATA[areaId];
                        if (area) availableAreas.push({ id: areaId, name: area.name });
                    });
                }
                // Sort: Bali 1, 2, 3 first, then others
                availableAreas.sort((a, b) => {
                    const order = ['bali1', 'bali2', 'bali3', 'jatim', 'lombok', 'jakarta', 'sulawesi', 'sumatera'];
                    return order.indexOf(a.id) - order.indexOf(b.id);
                });
                filterArea.innerHTML = '<option value="">Semua Area</option>' + availableAreas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

                // BM filter - show ALL unique BMs in managed areas
                let availableBM = [];
                availableAreas.forEach(area => {
                    const areaData = AREA_DATA[area.id];
                    if (areaData && areaData.bm && !availableBM.includes(areaData.bm)) {
                        availableBM.push(areaData.bm);
                    }
                });
                filterBM.innerHTML = '<option value="">Semua BM</option>' + availableBM.map(n => `<option value="${n}">${n}</option>`).join('');

                // AS filter - show ALL AS in managed areas (not just visited)
                let availableAS = [];
                availableAreas.forEach(area => {
                    const areaData = AREA_DATA[area.id];
                    if (areaData && areaData.as) {
                        availableAS.push(areaData.as);
                    }
                });
                filterAS.innerHTML = '<option value="">Semua AS</option>' + availableAS.map(n => `<option value="${n}">${n}</option>`).join('');
            } else {
                bmDashboard.style.display = 'none';
                leaderboard.style.display = 'none';
                filterBM.style.display = 'none';
                filterAS.style.display = 'none';
                filterArea.style.display = 'none';
            }

            // Store filter - show ALL stores in managed areas (not just visited)
            const allStores = stores.map(s => s.store);
            document.getElementById('filterStore').innerHTML = '<option value="">Semua Store</option>' + allStores.map(s => `<option value="${s}">${s}</option>`).join('');

            displayArchive(filtered);
        }

        // When area filter changes, update AS and store filter options
        function onAreaFilterChange() {
            const areaId = document.getElementById('filterArea').value;
            const storeFilter = document.getElementById('filterStore');
            const asFilter = document.getElementById('filterAS');
            const userStores = getUserStores();

            if (areaId) {
                // Filter by selected area - show ALL AS and stores in this area
                const areaData = AREA_DATA[areaId];
                const areaStores = areaData ? areaData.stores : [];

                // Update AS filter - show AS for this area
                const asInArea = areaData && areaData.as ? [areaData.as] : [];
                asFilter.innerHTML = '<option value="">Semua AS</option>' + asInArea.map(n => `<option value="${n}">${n}</option>`).join('');

                // Update store filter - show ALL stores in this area
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + areaStores.map(s => `<option value="${s}">${s}</option>`).join('');
            } else {
                // Show ALL AS and stores from user's managed areas
                let allAS = [];
                let allStores = [];

                if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                    Object.values(AREA_DATA).forEach(area => {
                        if (area.as) allAS.push(area.as);
                        allStores = allStores.concat(area.stores);
                    });
                } else if (currentUser.role === 'bm') {
                    const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                    bmAreas.forEach(areaId => {
                        const area = AREA_DATA[areaId];
                        if (area) {
                            if (area.as) allAS.push(area.as);
                            allStores = allStores.concat(area.stores);
                        }
                    });
                }

                asFilter.innerHTML = '<option value="">Semua AS</option>' + allAS.map(n => `<option value="${n}">${n}</option>`).join('');
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + allStores.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            filterArchive();
        }

        // When AS filter changes, update store filter options
        function onASFilterChange() {
            const areaId = document.getElementById('filterArea').value;
            const asName = document.getElementById('filterAS').value;
            const storeFilter = document.getElementById('filterStore');

            // Find which area this AS belongs to
            let areaStores = [];

            if (asName) {
                // Find area by AS name
                for (const [id, area] of Object.entries(AREA_DATA)) {
                    if (area.as === asName) {
                        areaStores = area.stores;
                        break;
                    }
                }
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + areaStores.map(s => `<option value="${s}">${s}</option>`).join('');
            } else if (areaId) {
                // Show stores for selected area
                const areaData = AREA_DATA[areaId];
                areaStores = areaData ? areaData.stores : [];
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + areaStores.map(s => `<option value="${s}">${s}</option>`).join('');
            } else {
                // Show all stores from user's managed areas
                let allStores = [];
                if (currentUser.role === 'admin' || currentUser.role === 'ho') {
                    Object.values(AREA_DATA).forEach(area => {
                        allStores = allStores.concat(area.stores);
                    });
                } else if (currentUser.role === 'bm') {
                    const bmAreas = Array.isArray(currentUser.area) ? currentUser.area : [currentUser.area];
                    bmAreas.forEach(areaId => {
                        const area = AREA_DATA[areaId];
                        if (area) allStores = allStores.concat(area.stores);
                    });
                }
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + allStores.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            filterArchive();
        }

        // When BM filter changes, update area, AS, and store filter options
        function onBMFilterChange() {
            const bmName = document.getElementById('filterBM').value;
            const areaFilter = document.getElementById('filterArea');
            const asFilter = document.getElementById('filterAS');
            const storeFilter = document.getElementById('filterStore');

            if (bmName) {
                // Find areas managed by this BM
                let bmAreas = [];
                let bmAS = [];
                let bmStores = [];
                for (const [id, area] of Object.entries(AREA_DATA)) {
                    if (area.bm === bmName) {
                        bmAreas.push({ id, name: area.name });
                        if (area.as) bmAS.push(area.as);
                        bmStores = bmStores.concat(area.stores);
                    }
                }
                areaFilter.innerHTML = '<option value="">Semua Area</option>' + bmAreas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                asFilter.innerHTML = '<option value="">Semua AS</option>' + bmAS.map(n => `<option value="${n}">${n}</option>`).join('');
                storeFilter.innerHTML = '<option value="">Semua Store</option>' + bmStores.map(s => `<option value="${s}">${s}</option>`).join('');
            } else {
                // Reset to show all
                openArchive();
                return;
            }

            filterArchive();
        }

        function filterArchive() {
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const stores = getUserStores().map(s => s.store);
            const areaFilter = document.getElementById('filterArea').value;
            const bmFilter = document.getElementById('filterBM').value;
            const storeFilter = document.getElementById('filterStore').value;
            const asFilter = document.getElementById('filterAS').value;
            const scoreFilter = document.getElementById('filterScore').value;

            let filtered = archive;
            if (currentUser.role === 'as') filtered = filtered.filter(a => a.visitorName === currentUser.name);
            else if (currentUser.role === 'bm') filtered = filtered.filter(a => stores.includes(a.storeName));

            // Filter by BM - get all stores managed by this BM
            if (bmFilter) {
                let bmStores = [];
                for (const [id, area] of Object.entries(AREA_DATA)) {
                    if (area.bm === bmFilter) {
                        bmStores = bmStores.concat(area.stores);
                    }
                }
                filtered = filtered.filter(a => bmStores.includes(a.storeName));
            }

            // Filter by area
            if (areaFilter) {
                const areaStores = getStoresForArea(areaFilter);
                filtered = filtered.filter(a => areaStores.includes(a.storeName));
            }

            if (storeFilter) filtered = filtered.filter(a => a.storeName === storeFilter);
            if (asFilter) filtered = filtered.filter(a => a.visitorName === asFilter);
            if (scoreFilter === 'good') filtered = filtered.filter(a => a.score >= 80);
            else if (scoreFilter === 'average') filtered = filtered.filter(a => a.score >= 60 && a.score < 80);
            else if (scoreFilter === 'poor') filtered = filtered.filter(a => a.score < 60);

            displayArchive(filtered);
        }

        // Selection mode state
        let isSelectMode = false;

        function displayArchive(archive) {
            const list = document.getElementById('archiveList');
            const bulkDeleteControls = document.getElementById('bulkDeleteControls');
            const canDelete = currentUser.role === 'admin' || currentUser.role === 'bm';

            // Show/hide bulk delete controls
            if (bulkDeleteControls) {
                bulkDeleteControls.style.display = canDelete && archive.length > 0 ? 'block' : 'none';
            }

            // Reset selection mode UI
            resetSelectModeUI();

            if (archive.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Belum ada arsip visit</p>';
                return;
            }
            const showScore = currentUser.role !== 'as';
            const canClick = currentUser.role === 'bm' || currentUser.role === 'admin' || currentUser.role === 'as' || currentUser.role === 'ho';
            list.innerHTML = archive.map((item, idx) => {
                const hasProof = item.visitProof && item.visitProof.photo;
                const hasGPS = item.visitProof && item.visitProof.location;
                const hasBmReview = item.bmReview && item.bmReview.comment;
                const area = getAreaForStore(item.storeName);
                const areaName = area ? area.name : '';
                return `
                <div class="archive-item" style="cursor:pointer; display:flex; align-items:center;">
                    ${canDelete ? `<input type="checkbox" class="archive-checkbox" data-formno="${item.formNo}" onchange="updateSelectedCount()" onclick="event.stopPropagation()" style="width:18px; height:18px; margin-right:12px; cursor:pointer; flex-shrink:0; display:none;">` : ''}
                    <div class="archive-item-info" style="flex:1;" ${canClick ? `onclick="openArchiveDetail('${item.formNo}')"` : ''}>
                        <h4>${item.storeName} ${hasProof ? '<span title="Foto bukti visit" style="color:#28a745;">&#128247;</span>' : ''} ${hasGPS ? '<span title="GPS tersedia" style="color:#28a745;">&#128205;</span>' : ''} ${hasBmReview ? '<span title="Review dari BM" style="color:#ffc107;">&#128172;</span>' : ''}</h4>
                        <p><span style="background:#e9ecef;padding:2px 6px;border-radius:4px;font-size:0.75rem;margin-right:5px;">${areaName}</span>${item.formNo} | ${new Date(item.visitDate).toLocaleDateString('id-ID')} | AS: ${item.visitorName}</p>
                    </div>
                    <div class="archive-item-actions">
                        ${showScore ? `<div class="archive-item-score ${item.score >= 80 ? 'good' : item.score >= 60 ? 'average' : 'poor'}">${item.score}</div>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function deleteArchiveItem(formNo) {
            if (!confirm('Apakah Anda yakin ingin menghapus arsip visit ini?')) return;

            let archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const itemIndex = archive.findIndex(a => a.formNo === formNo);

            if (itemIndex === -1) {
                alert('Data tidak ditemukan');
                return;
            }

            // Remove item from archive
            archive.splice(itemIndex, 1);
            localStorage.setItem('visit_archive', JSON.stringify(archive));

            // Delete from Google Sheets
            try {
                fetch(GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'delete',
                        formNo: formNo
                    })
                });
            } catch (e) {
                console.log('Google Sheets delete error:', e);
            }

            // Refresh archive list
            filterArchive();

            // Update dashboard if needed
            if (typeof updateDashboard === 'function') {
                updateDashboard();
            }

            alert('Arsip visit berhasil dihapus');
        }

        // ========================================
        // BULK DELETE FUNCTIONS
        // ========================================
        function resetSelectModeUI() {
            isSelectMode = false;
            const startBtn = document.getElementById('startSelectBtn');
            const selectModeControls = document.getElementById('selectModeControls');
            const selectAllCheckbox = document.getElementById('selectAllArchive');

            if (startBtn) startBtn.style.display = 'block';
            if (selectModeControls) selectModeControls.style.display = 'none';
            if (selectAllCheckbox) selectAllCheckbox.checked = false;

            // Hide all checkboxes
            document.querySelectorAll('.archive-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });

            updateSelectedCount();
        }

        function startSelectMode() {
            isSelectMode = true;
            const startBtn = document.getElementById('startSelectBtn');
            const selectModeControls = document.getElementById('selectModeControls');
            const selectAllCheckbox = document.getElementById('selectAllArchive');

            if (startBtn) startBtn.style.display = 'none';
            if (selectModeControls) selectModeControls.style.display = 'flex';

            // Show all checkboxes (unchecked - user selects manually)
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            checkboxes.forEach(cb => {
                cb.style.display = 'block';
                cb.checked = false;
            });

            // Uncheck select all
            if (selectAllCheckbox) selectAllCheckbox.checked = false;

            updateSelectedCount();
        }

        function cancelSelectMode() {
            resetSelectModeUI();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllArchive');
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.archive-checkbox:checked');
            const countEl = document.getElementById('selectedCount');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const count = checkboxes.length;

            if (countEl) countEl.textContent = `(${count} dipilih)`;
            if (bulkDeleteBtn) bulkDeleteBtn.style.display = count > 0 ? 'block' : 'none';
        }

        async function bulkDeleteArchive() {
            const checkboxes = document.querySelectorAll('.archive-checkbox:checked');
            const formNos = Array.from(checkboxes).map(cb => cb.dataset.formno);

            if (formNos.length === 0) {
                alert('Pilih minimal 1 arsip untuk dihapus');
                return;
            }

            if (!confirm(`Apakah Anda yakin ingin menghapus ${formNos.length} arsip visit?`)) return;

            // Show loading
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const originalText = bulkDeleteBtn.innerHTML;
            bulkDeleteBtn.innerHTML = 'â³ Menghapus...';
            bulkDeleteBtn.disabled = true;

            let archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');

            // Remove items from localStorage
            archive = archive.filter(a => !formNos.includes(a.formNo));
            localStorage.setItem('visit_archive', JSON.stringify(archive));

            // Delete from Google Sheets (one by one)
            for (const formNo of formNos) {
                try {
                    await fetch(GOOGLE_SHEETS_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'delete',
                            formNo: formNo
                        })
                    });
                } catch (e) {
                    console.log('Google Sheets delete error for ' + formNo + ':', e);
                }
            }

            // Reset button
            bulkDeleteBtn.innerHTML = originalText;
            bulkDeleteBtn.disabled = false;

            // Reset selection mode
            isSelectMode = false;

            // Refresh archive list
            filterArchive();

            // Update dashboard if needed
            if (typeof updateDashboard === 'function') {
                updateDashboard();
            }

            alert(`${formNos.length} arsip visit berhasil dihapus`);
        }

        // ========================================
        // ARCHIVE DETAIL & BM REVIEW
        // ========================================
        let currentDetailFormNo = null;

        function openArchiveDetail(formNo) {
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const item = archive.find(a => a.formNo === formNo);
            if (!item) return;

            currentDetailFormNo = formNo;
            const body = document.getElementById('archiveDetailBody');

            // Build checklist summary
            let checklistHtml = '';
            const categories = ['ambiance', 'display', 'admin', 'cleaning', 'spg', 'stock'];
            categories.forEach(cat => {
                CHECKLIST_DATA[cat].forEach(ci => {
                    const answer = item.answers[ci.no] || '-';
                    const statusClass = answer === 'yes' ? 'yes' : answer === 'no' ? 'no' : 'na';
                    const statusText = answer === 'yes' ? 'YES' : answer === 'no' ? 'NO' : answer === 'na' ? 'N/A' : '-';
                    checklistHtml += `
                        <div class="checklist-summary-item">
                            <span class="status ${statusClass}">${statusText}</span>
                            <span>${ci.no}. ${ci.text}</span>
                        </div>`;
                });
            });

            // Count YES/NO/NA
            let yesCount = 0, noCount = 0, naCount = 0;
            Object.values(item.answers || {}).forEach(a => {
                if (a === 'yes') yesCount++;
                else if (a === 'no') noCount++;
                else if (a === 'na') naCount++;
            });
            const score = (yesCount + noCount) > 0 ? Math.round((yesCount / (yesCount + noCount)) * 100) : 0;

            // Visit proof
            const proofPhoto = item.visitProof?.photo || null;
            const proofTime = item.visitProof?.timestamp ? new Date(item.visitProof.timestamp).toLocaleString('id-ID') : '-';
            const proofLoc = item.visitProof?.location ? `${item.visitProof.location.lat}, ${item.visitProof.location.lng}` : '-';

            // BM Review section - only show for BM/Admin, AS can only view
            const canReview = currentUser.role === 'bm' || currentUser.role === 'admin';
            const existingReview = item.bmReview;

            body.innerHTML = `
                <div class="detail-section">
                    <h4>&#128203; Informasi Visit</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Store</div>
                            <div class="value">${item.storeName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Tanggal Visit</div>
                            <div class="value">${new Date(item.visitDate).toLocaleDateString('id-ID')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Area Supervisor</div>
                            <div class="value">${item.visitorName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Form No</div>
                            <div class="value">${item.formNo}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>&#128205; Bukti Visit</h4>
                    <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;">
                        ${proofPhoto ? `<img src="${proofPhoto}" class="visit-proof-thumbnail" onclick="window.open('${proofPhoto}','_blank')">` : '<span style="color:#999;">Tidak ada foto</span>'}
                        <div>
                            <div class="detail-item" style="margin-bottom:10px;">
                                <div class="label">Waktu Check-in</div>
                                <div class="value">${proofTime}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Lokasi GPS</div>
                                <div class="value">${proofLoc !== '-' ? `<a href="https://maps.google.com/?q=${item.visitProof.location.lat},${item.visitProof.location.lng}" target="_blank">${proofLoc}</a>` : proofLoc}</div>
                            </div>
                        </div>
                    </div>
                </div>

                ${currentUser.role !== 'as' ? `
                <div class="detail-section">
                    <h4>&#127919; Hasil Penilaian</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Score</div>
                            <div class="value" style="font-size:1.5rem;color:${score >= 80 ? '#28a745' : score >= 60 ? '#ffc107' : '#dc3545'};">${score} (${score >= 80 ? 'GOOD' : score >= 60 ? 'AVERAGE' : 'POOR'})</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Summary</div>
                            <div class="value" style="color:#28a745;">YES: ${yesCount}</div>
                            <div class="value" style="color:#dc3545;">NO: ${noCount}</div>
                            <div class="value" style="color:#6c757d;">N/A: ${naCount}</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div class="detail-section">
                    <h4>&#9745; Detail Checklist</h4>
                    <div class="checklist-summary">
                        ${checklistHtml}
                    </div>
                </div>

                ${item.comment ? `
                <div class="detail-section">
                    <h4>&#128221; Catatan AS</h4>
                    <p>${item.comment}</p>
                </div>
                ` : ''}

                ${existingReview ? `
                <div class="existing-review">
                    <div class="review-header">Review dari ${existingReview.reviewerName} (${existingReview.reviewerRole.toUpperCase()}) - ${new Date(existingReview.reviewedAt).toLocaleString('id-ID')}</div>
                    <div class="review-content">${existingReview.comment}</div>
                </div>
                ` : ''}

                ${canReview ? `
                <div class="bm-review-section">
                    <h4>&#128172; ${existingReview ? 'Update Review' : 'Berikan Review / Feedback'}</h4>
                    <textarea id="bmReviewText" placeholder="Tuliskan review, feedback, atau improvement untuk AS...">${existingReview ? existingReview.comment : ''}</textarea>
                    <button class="btn-submit-review" onclick="submitBmReview()">&#10004; ${existingReview ? 'Update Review' : 'Submit Review'}</button>
                </div>
                ` : ''}
            `;

            document.getElementById('archiveDetailModal').classList.add('show');
        }

        function closeArchiveDetail() {
            document.getElementById('archiveDetailModal').classList.remove('show');
            currentDetailFormNo = null;
        }

        function submitBmReview() {
            const reviewText = document.getElementById('bmReviewText').value.trim();
            if (!reviewText) {
                alert('Tuliskan review terlebih dahulu!');
                return;
            }

            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const idx = archive.findIndex(a => a.formNo === currentDetailFormNo);
            if (idx === -1) return;

            const reviewedAt = new Date().toISOString();

            archive[idx].bmReview = {
                comment: reviewText,
                reviewerName: currentUser.name,
                reviewerRole: currentUser.role,
                reviewedAt: reviewedAt
            };

            localStorage.setItem('visit_archive', JSON.stringify(archive));

            // Get AS email for notification
            const storeName = archive[idx].storeName;
            const visitorName = archive[idx].visitorName;
            const asEmail = getASEmailForStore(storeName);

            // Sync BM Review to Google Sheets with notification
            try {
                fetch(GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateReview',
                        formNo: currentDetailFormNo,
                        bmReview: reviewText,
                        bmReviewBy: currentUser.name,
                        bmReviewDate: reviewedAt,
                        // Email notification data (BM review -> notify AS)
                        sendNotification: asEmail ? true : false,
                        notificationType: 'review',
                        notifyEmails: asEmail ? [asEmail] : [],
                        storeName: storeName,
                        visitorName: visitorName
                    })
                });
            } catch (e) {
                console.log('Google Sheets review sync error:', e);
            }

            alert('Review berhasil disimpan!');
            closeArchiveDetail();
            loadArchive();
        }

        // Close modal on background click
        document.addEventListener('click', function(e) {
            if (e.target.id === 'archiveDetailModal') closeArchiveDetail();
        });

        // ========================================
        // SAVE VISIT
        // ========================================
        async function saveVisit() {
            const storeName = document.getElementById('storeName').value;
            const visitDate = document.getElementById('visitDate').value;
            const visitorName = document.getElementById('visitorName').value.trim();
            const comment = document.getElementById('commentImprovement').value.trim();

            // Validasi
            if (!storeName) { alert('Pilih store terlebih dahulu!'); return; }
            if (!visitProofData.photo) { alert('Upload foto bukti visit terlebih dahulu!'); return; }
            if (!visitProofData.location && !confirm('Lokasi GPS belum diambil. Lanjutkan tanpa lokasi?')) return;
            if (Object.keys(checklistAnswers).length < 42 && !confirm('Checklist belum lengkap (' + Object.keys(checklistAnswers).length + '/42). Lanjutkan?')) return;

            // Hitung score
            let yesCount = 0, noCount = 0;
            Object.values(checklistAnswers).forEach(a => {
                if (a === 'yes') yesCount++;
                else if (a === 'no') noCount++;
            });
            const score = (yesCount + noCount) > 0 ? Math.round((yesCount / (yesCount + noCount)) * 100) : 0;

            // Generate form number
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const formNo = `VIS-${dateStr}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;

            // Get area name
            const area = getAreaForStore(storeName);
            const areaName = area ? area.name : '';

            const createdAt = new Date().toISOString();

            // Show loading
            const saveBtn = document.querySelector('.btn-primary[onclick="saveVisit()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'â³ Menyimpan...';
            saveBtn.disabled = true;

            // Generate PDF
            let pdfBase64 = '';
            try {
                pdfBase64 = generatePdfBase64(formNo, storeName, visitDate, visitorName, areaName, score, comment);
            } catch (e) {
                console.log('PDF generation error:', e);
            }

            // Data to save
            const visitData = {
                formNo,
                storeName,
                visitDate,
                score,
                answers: { ...checklistAnswers },
                remarks: { ...checklistRemarks },
                photos: { ...checklistPhotos },
                visitorName,
                areaName,
                comment,
                visitProof: {
                    photo: visitProofData.photo,
                    timestamp: visitProofData.timestamp,
                    location: visitProofData.location
                },
                createdAt
            };

            // Save to localStorage
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            archive.unshift(visitData);
            localStorage.setItem('visit_archive', JSON.stringify(archive));

            // Get BM email for notification
            const bmEmail = getBMEmailForStore(storeName);
            console.log('BM Email for notification:', bmEmail);

            // Save to Google Sheets with PDF and send notification
            try {
                const savePayload = {
                    action: 'save',
                    formNo,
                    storeName,
                    visitDate,
                    score,
                    visitorName,
                    areaName,
                    comment,
                    createdAt,
                    pdfBase64,
                    // Email notification data (AS submit -> notify BM)
                    sendNotification: bmEmail ? true : false,
                    notificationType: 'visit',
                    notifyEmails: bmEmail ? [bmEmail] : []
                };
                console.log('Sending to Google Sheets with notification:', savePayload.sendNotification, savePayload.notifyEmails);

                const response = await fetch(GOOGLE_SHEETS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(savePayload)
                });
                const result = await response.json();
                console.log('Google Sheets response:', result);
            } catch (e) {
                console.log('Google Sheets sync error:', e);
            }

            // Restore button
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            alert('Visit berhasil disimpan! PDF tersimpan di Google Drive.');

            if (confirm('Buat visit baru?')) {
                resetForm();
            }

            // Update dashboard
            initDashboard();
        }

        // Generate PDF and return as base64 - SIMPLE VERSION
        function generatePdfBase64(formNo, storeName, visitDate, visitorName, areaName, score, comment) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // ===== HEADER =====
                doc.setFillColor(26, 26, 46);
                doc.rect(0, 0, 210, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('STORE VISIT CHECKLIST', 105, 12, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Area Supervisor Visit Report', 105, 19, { align: 'center' });
                doc.setFontSize(9);
                doc.text(String(formNo || ''), 105, 26, { align: 'center' });

                // ===== INFO BOX =====
                let y = 38;
                const areaInfo = getAreaForStore(storeName);
                const bmName = areaInfo && AREA_DATA[areaInfo.id] ? AREA_DATA[areaInfo.id].bm || '-' : '-';

                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.rect(15, y - 3, 180, 28);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);

                const labelX = 20;
                const valueX = 55;
                const labelX2 = 115;
                const valueX2 = 150;

                // Row 1
                doc.setFont('helvetica', 'bold');
                doc.text('Store', labelX, y + 3);
                doc.text(':', 50, y + 3);
                doc.setFont('helvetica', 'normal');
                doc.text(String(storeName || ''), valueX, y + 3);

                doc.setFont('helvetica', 'bold');
                doc.text('Tanggal', labelX2, y + 3);
                doc.text(':', 145, y + 3);
                doc.setFont('helvetica', 'normal');
                try {
                    doc.text(new Date(visitDate).toLocaleDateString('id-ID'), valueX2, y + 3);
                } catch(e) {
                    doc.text(String(visitDate || ''), valueX2, y + 3);
                }

                // Row 2
                doc.setFont('helvetica', 'bold');
                doc.text('Area Supervisor', labelX, y + 11);
                doc.text(':', 50, y + 11);
                doc.setFont('helvetica', 'normal');
                doc.text(String(visitorName || ''), valueX, y + 11);

                doc.setFont('helvetica', 'bold');
                doc.text('Area', labelX2, y + 11);
                doc.text(':', 145, y + 11);
                doc.setFont('helvetica', 'normal');
                doc.text(String(areaName || ''), valueX2, y + 11);

                // Row 3
                doc.setFont('helvetica', 'bold');
                doc.text('Branch Manager', labelX, y + 19);
                doc.text(':', 50, y + 19);
                doc.setFont('helvetica', 'normal');
                doc.text(bmName, valueX, y + 19);

                // ===== SCORE SUMMARY =====
                y = 72;
                let yesCount = 0, noCount = 0, naCount = 0;
                Object.values(checklistAnswers).forEach(a => {
                    if (a === 'yes') yesCount++;
                    else if (a === 'no') noCount++;
                    else if (a === 'na') naCount++;
                });

                const scoreColor = score >= 80 ? [40, 167, 69] : score >= 60 ? [255, 193, 7] : [220, 53, 69];
                const scoreLabel = score >= 80 ? 'GOOD' : score >= 60 ? 'AVERAGE' : 'POOR';

                doc.setFillColor(...scoreColor);
                doc.roundedRect(15, y, 35, 18, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${score}%`, 32.5, y + 9, { align: 'center' });
                doc.setFontSize(8);
                doc.text(scoreLabel, 32.5, y + 15, { align: 'center' });

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`YES: ${yesCount}`, 58, y + 7);
                doc.text(`NO: ${noCount}`, 58, y + 14);
                doc.text(`N/A: ${naCount}`, 85, y + 7);
                doc.text(`Total: ${yesCount + noCount + naCount}`, 85, y + 14);

                // ===== CHECKLIST TABLE =====
                y = 95;
                const categories = [
                    { key: 'ambiance', name: 'STORE AMBIANCE' },
                    { key: 'display', name: 'DISPLAY' },
                    { key: 'admin', name: 'STORE ADMINISTRASI' },
                    { key: 'cleaning', name: 'STORE CLEANING' },
                    { key: 'spg', name: 'SPG' },
                    { key: 'stock', name: 'STOCK' }
                ];

                const tableLeft = 15;
                const tableWidth = 180;
                const colNo = 12;

                categories.forEach(cat => {
                    if (y > 250) { doc.addPage(); y = 15; }

                    doc.setFillColor(15, 52, 96);
                    doc.rect(tableLeft, y, tableWidth, 7, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cat.name, tableLeft + 3, y + 5);
                    y += 7;

                    doc.setFillColor(240, 240, 240);
                    doc.rect(tableLeft, y, tableWidth, 6, 'F');
                    doc.setTextColor(80, 80, 80);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('No', tableLeft + 3, y + 4);
                    doc.text('Item Checklist', tableLeft + colNo + 3, y + 4);
                    doc.text('Status', tableLeft + tableWidth - 12, y + 4);
                    y += 6;

                    doc.setFontSize(8);
                    CHECKLIST_DATA[cat.key].forEach((item, idx) => {
                        if (y > 275) { doc.addPage(); y = 15; }

                        const answer = checklistAnswers[item.no] || '-';
                        const answerText = answer === 'yes' ? 'YES' : answer === 'no' ? 'NO' : answer === 'na' ? 'N/A' : '-';
                        const rowHeight = 6;

                        if (idx % 2 === 0) {
                            doc.setFillColor(252, 252, 252);
                            doc.rect(tableLeft, y, tableWidth, rowHeight, 'F');
                        }

                        doc.setDrawColor(220, 220, 220);
                        doc.setLineWidth(0.2);
                        doc.line(tableLeft, y + rowHeight, tableLeft + tableWidth, y + rowHeight);

                        doc.setTextColor(100, 100, 100);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${item.no}`, tableLeft + 3, y + 4);

                        doc.setTextColor(0, 0, 0);
                        let itemText = item.text;
                        if (itemText.length > 85) itemText = itemText.substring(0, 82) + '...';
                        doc.text(itemText, tableLeft + colNo + 2, y + 4);

                        if (answer === 'yes') doc.setTextColor(40, 167, 69);
                        else if (answer === 'no') doc.setTextColor(220, 53, 69);
                        else doc.setTextColor(150, 150, 150);
                        doc.setFont('helvetica', 'bold');
                        doc.text(answerText, tableLeft + tableWidth - 5, y + 4, { align: 'right' });

                        y += rowHeight;
                    });

                    y += 8;
                });

                const pdfOutput = doc.output('datauristring');
                return pdfOutput.split(',')[1];
            } catch (err) {
                console.error('PDF Error:', err);
                return '';
            }
        }

        // ========================================
        // PDF GENERATION
        // ========================================
        function generatePDF() {
            const storeName = document.getElementById('storeName').value;
            const visitDate = document.getElementById('visitDate').value;
            const visitorName = document.getElementById('visitorName').value.trim();

            if (!storeName) { alert('Pilih store terlebih dahulu!'); return; }
            if (!visitProofData.photo) { alert('Upload foto bukti visit terlebih dahulu!'); return; }
            if (!visitProofData.location && !confirm('Lokasi GPS belum diambil. Lanjutkan tanpa lokasi?')) return;
            if (Object.keys(checklistAnswers).length < 42 && !confirm('Checklist belum lengkap. Lanjutkan?')) return;

            // Check if store already visited this month
            const existingArchive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            const currentMonth = new Date(visitDate).getMonth();
            const currentYear = new Date(visitDate).getFullYear();

            const storeVisits = existingArchive.filter(v => v.storeName === storeName);
            const thisMonthVisits = storeVisits.filter(v => {
                const vDate = new Date(v.visitDate);
                return vDate.getMonth() === currentMonth && vDate.getFullYear() === currentYear;
            });

            if (thisMonthVisits.length > 0) {
                const lastVisit = thisMonthVisits[0];
                const lastVisitDate = new Date(lastVisit.visitDate).toLocaleDateString('id-ID');
                const totalVisits = storeVisits.length;

                const confirmMsg = `Store "${storeName}" sudah di-visit bulan ini!\n\n` +
                    `Visit terakhir: ${lastVisitDate}\n` +
                    `Total visit store ini: ${totalVisits}x\n\n` +
                    `Lanjutkan visit baru?`;

                if (!confirm(confirmMsg)) return;
            }

            let yesCount = 0, noCount = 0, naCount = 0;
            Object.values(checklistAnswers).forEach(a => {
                if (a === 'yes') yesCount++;
                else if (a === 'no') noCount++;
                else if (a === 'na') naCount++;
            });
            const score = (yesCount + noCount) > 0 ? Math.round((yesCount / (yesCount + noCount)) * 100) : 0;
            const comment = document.getElementById('commentImprovement').value.trim();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Generate form number
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const formNo = `VIS-${dateStr}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;

            // ===== HEADER =====
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('STORE VISIT CHECKLIST', 105, 12, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Area Supervisor Visit Report', 105, 19, { align: 'center' });
            doc.setFontSize(9);
            doc.text(formNo, 105, 26, { align: 'center' });

            // ===== INFO BOX =====
            let y = 38;
            const areaInfo = getAreaForStore(storeName);
            const areaName = areaInfo ? areaInfo.area : '';
            const bmName = areaInfo && AREA_DATA[areaInfo.id] ? AREA_DATA[areaInfo.id].bm || '-' : '-';

            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.rect(15, y - 3, 180, 36);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);

            // Row 1: Store & Tanggal
            const labelX = 20;
            const valueX = 55;
            const labelX2 = 115;
            const valueX2 = 150;

            doc.setFont('helvetica', 'bold');
            doc.text('Store', labelX, y + 3);
            doc.text(':', 50, y + 3);
            doc.setFont('helvetica', 'normal');
            doc.text(storeName, valueX, y + 3);

            doc.setFont('helvetica', 'bold');
            doc.text('Tanggal', labelX2, y + 3);
            doc.text(':', 145, y + 3);
            doc.setFont('helvetica', 'normal');
            doc.text(new Date(visitDate).toLocaleDateString('id-ID'), valueX2, y + 3);

            // Row 2: Area Supervisor & Area
            doc.setFont('helvetica', 'bold');
            doc.text('Area Supervisor', labelX, y + 11);
            doc.text(':', 50, y + 11);
            doc.setFont('helvetica', 'normal');
            doc.text(visitorName, valueX, y + 11);

            doc.setFont('helvetica', 'bold');
            doc.text('Area', labelX2, y + 11);
            doc.text(':', 145, y + 11);
            doc.setFont('helvetica', 'normal');
            doc.text(areaName, valueX2, y + 11);

            // Row 3: BM & Check-in
            doc.setFont('helvetica', 'bold');
            doc.text('Branch Manager', labelX, y + 19);
            doc.text(':', 50, y + 19);
            doc.setFont('helvetica', 'normal');
            doc.text(bmName, valueX, y + 19);

            if (visitProofData.timestamp) {
                doc.setFont('helvetica', 'bold');
                doc.text('Check-in', labelX2, y + 19);
                doc.text(':', 145, y + 19);
                doc.setFont('helvetica', 'normal');
                doc.text(new Date(visitProofData.timestamp).toLocaleString('id-ID'), valueX2, y + 19);
            }

            // Row 4: Lokasi (if available)
            if (visitProofData.location) {
                doc.setFont('helvetica', 'bold');
                doc.text('Lokasi', labelX, y + 27);
                doc.text(':', 50, y + 27);
                doc.setFont('helvetica', 'normal');
                const locText = visitProofData.location.address ?
                    visitProofData.location.address.substring(0, 70) :
                    `${visitProofData.location.lat}, ${visitProofData.location.lng}`;
                doc.text(locText, valueX, y + 27);
            }

            // ===== SCORE SUMMARY BOX =====
            y = 80;
            const scoreColor = score >= 80 ? [40, 167, 69] : score >= 60 ? [255, 193, 7] : [220, 53, 69];
            const scoreLabel = score >= 80 ? 'GOOD' : score >= 60 ? 'AVERAGE' : 'POOR';

            // Score box
            doc.setFillColor(...scoreColor);
            doc.roundedRect(15, y, 35, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`${score}%`, 32.5, y + 9, { align: 'center' });
            doc.setFontSize(8);
            doc.text(scoreLabel, 32.5, y + 15, { align: 'center' });

            // Summary counts
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`YES: ${yesCount}`, 58, y + 7);
            doc.text(`NO: ${noCount}`, 58, y + 14);
            doc.text(`N/A: ${naCount}`, 85, y + 7);
            doc.text(`Total: ${yesCount + noCount + naCount}`, 85, y + 14);

            // ===== CHECKLIST TABLE =====
            y = 103;
            const categories = [
                { key: 'ambiance', name: 'STORE AMBIANCE' },
                { key: 'display', name: 'DISPLAY' },
                { key: 'admin', name: 'STORE ADMINISTRASI' },
                { key: 'cleaning', name: 'STORE CLEANING' },
                { key: 'spg', name: 'SPG' },
                { key: 'stock', name: 'STOCK' }
            ];

            const tableLeft = 15;
            const tableWidth = 180;
            const colNo = 12;
            const colAnswer = 18;
            const colText = tableWidth - colNo - colAnswer;

            categories.forEach(cat => {
                if (y > 250) { doc.addPage(); y = 15; }

                // Category header
                doc.setFillColor(15, 52, 96);
                doc.rect(tableLeft, y, tableWidth, 7, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(cat.name, tableLeft + 3, y + 5);
                y += 7;

                // Table header row
                doc.setFillColor(240, 240, 240);
                doc.rect(tableLeft, y, tableWidth, 6, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('No', tableLeft + 3, y + 4);
                doc.text('Item Checklist', tableLeft + colNo + 3, y + 4);
                doc.text('Status', tableLeft + tableWidth - 12, y + 4);
                y += 6;

                doc.setFontSize(8);
                CHECKLIST_DATA[cat.key].forEach((item, idx) => {
                    if (y > 275) { doc.addPage(); y = 15; }

                    const answer = checklistAnswers[item.no] || '-';
                    const answerText = answer === 'yes' ? 'YES' : answer === 'no' ? 'NO' : answer === 'na' ? 'N/A' : '-';
                    const rowHeight = 6;

                    // Alternating row color
                    if (idx % 2 === 0) {
                        doc.setFillColor(252, 252, 252);
                        doc.rect(tableLeft, y, tableWidth, rowHeight, 'F');
                    }

                    // Row border
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.2);
                    doc.line(tableLeft, y + rowHeight, tableLeft + tableWidth, y + rowHeight);

                    // No column
                    doc.setTextColor(100, 100, 100);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${item.no}`, tableLeft + 3, y + 4);

                    // Text column (truncate if too long)
                    doc.setTextColor(0, 0, 0);
                    let itemText = item.text;
                    if (itemText.length > 85) itemText = itemText.substring(0, 82) + '...';
                    doc.text(itemText, tableLeft + colNo + 2, y + 4);

                    // Answer column with color
                    if (answer === 'yes') doc.setTextColor(40, 167, 69);
                    else if (answer === 'no') doc.setTextColor(220, 53, 69);
                    else doc.setTextColor(150, 150, 150);
                    doc.setFont('helvetica', 'bold');
                    doc.text(answerText, tableLeft + tableWidth - 5, y + 4, { align: 'right' });

                    y += rowHeight;
                });

                y += 8;
            });

            // Save archive
            const archive = JSON.parse(localStorage.getItem('visit_archive') || '[]');
            archive.unshift({
                formNo,
                storeName,
                visitDate,
                score,
                answers: { ...checklistAnswers },
                remarks: { ...checklistRemarks },
                photos: { ...checklistPhotos },
                visitorName,
                areaName,
                comment,
                visitProof: {
                    photo: visitProofData.photo,
                    timestamp: visitProofData.timestamp,
                    location: visitProofData.location
                },
                createdAt: new Date().toISOString()
            });
            localStorage.setItem('visit_archive', JSON.stringify(archive));

            doc.save(`Visit_${storeName.replace(/\s+/g, '_')}_${visitDate}.pdf`);

            if (confirm('PDF berhasil! Buat visit baru?')) resetForm();
        }

        function resetForm() {
            checklistAnswers = {};
            checklistRemarks = {};
            checklistPhotos = {};
            visitProofData = { photo: null, timestamp: null, location: null };
            document.getElementById('storeName').value = '';
            document.getElementById('commentImprovement').value = '';

            // Reset visit proof display
            document.getElementById('visitProofPreview').innerHTML = '<span class="placeholder">&#128247;</span>';
            document.getElementById('visitProofTime').textContent = '-';
            document.getElementById('visitProofTimeStatus').textContent = 'Menunggu';
            document.getElementById('visitProofTimeStatus').className = 'status pending';
            document.getElementById('visitProofLocation').textContent = '-';
            const locBtn = document.getElementById('getLocationBtn');
            locBtn.textContent = 'Ambil Lokasi';
            locBtn.className = 'get-location-btn';
            locBtn.disabled = false;
            document.getElementById('visitProofStatus').textContent = 'Belum Check-in';
            document.getElementById('visitCheckinStatus').textContent = 'Pending';
            document.getElementById('visitCheckinStatus').className = 'status pending';

            initChecklists();
            updateProgress();
            updateScore();
            Object.keys(CHECKLIST_DATA).forEach(cat => updateCategoryBadge(cat));
            initDashboard();
        }

        document.getElementById('archiveModal').addEventListener('click', function(e) { if (e.target === this) closeArchive(); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeArchive(); });
    </script>
</body>
<!-- Updated: 2026-01-06 22:40:00 -->
</html>
